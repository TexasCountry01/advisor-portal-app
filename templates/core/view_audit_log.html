{% extends 'base.html' %}
{% load static %}

{% block title %}Audit Log - Advisor Portal{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1><i class="fas fa-history"></i> Audit Log</h1>
            <p class="text-muted">Complete activity trail of all user actions in the system</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'export_audit_log_csv' %}?{{ request.GET.urlencode }}" class="btn btn-success">
                <i class="fas fa-download"></i> Export CSV
            </a>
            <a href="{% url 'cases:admin_dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Filter Panel -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="fas fa-filter"></i> Filters</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <!-- User Filter -->
                <div class="col-md-3">
                    <label for="userFilter" class="form-label">User</label>
                    <select class="form-select" id="userFilter" name="user">
                        <option value="">All Users</option>
                        {% for user in users %}
                            <option value="{{ user.id }}" {% if user_filter|add:0 == user.id %}selected{% endif %}>
                                {{ user.username }} ({{ user.get_role_display }})
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Action Type Filter -->
                <div class="col-md-3">
                    <label for="actionFilter" class="form-label">Action Type</label>
                    <select class="form-select" id="actionFilter" name="action">
                        <option value="">All Actions</option>
                        {% for code, label in action_types %}
                            <option value="{{ code }}" {% if action_filter == code %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Date Range -->
                <div class="col-md-2">
                    <label for="dateFrom" class="form-label">From Date</label>
                    <input type="date" class="form-control" id="dateFrom" name="date_from" value="{{ date_from }}">
                </div>

                <div class="col-md-2">
                    <label for="dateTo" class="form-label">To Date</label>
                    <input type="date" class="form-control" id="dateTo" name="date_to" value="{{ date_to }}">
                </div>

                <!-- Case ID -->
                <div class="col-md-2">
                    <label for="caseId" class="form-label">Case ID</label>
                    <input type="text" class="form-control" id="caseId" name="case_id" placeholder="Case #" value="{{ case_id }}">
                </div>

                <!-- Search -->
                <div class="col-md-4">
                    <label for="searchQuery" class="form-label">Search</label>
                    <input type="text" class="form-control" id="searchQuery" name="search" 
                           placeholder="Username, case number, description..." value="{{ search_query }}">
                </div>

                <!-- Buttons -->
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Apply Filters
                    </button>
                    <a href="{% url 'view_audit_log' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-redo"></i> Reset
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Summary -->
    <div class="alert alert-info">
        <strong>{{ total_logs }}</strong> audit log entries found
        {% if search_query or user_filter or action_filter or date_from or date_to or case_id %}
            (filtered)
        {% endif %}
    </div>

    <!-- Audit Log Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Timestamp</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Description</th>
                        <th>Case</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in audit_logs %}
                        <tr>
                            <td>
                                <small class="text-muted">{{ log.timestamp|date:"M d, Y H:i" }}</small>
                            </td>
                            <td>
                                {% if log.user %}
                                    <strong>{{ log.user.username }}</strong>
                                    <br>
                                    <small class="text-muted">{{ log.user.get_role_display }}</small>
                                {% else %}
                                    <span class="badge bg-secondary">System</span>
                                {% endif %}
                            </td>
                            <td>
                                {% with action_display=log.get_action_type_display %}
                                    {% if "login" in log.action_type %}
                                        <span class="badge bg-success">{{ action_display }}</span>
                                    {% elif "logout" in log.action_type %}
                                        <span class="badge bg-info">{{ action_display }}</span>
                                    {% elif "created" in log.action_type %}
                                        <span class="badge bg-primary">{{ action_display }}</span>
                                    {% elif "deleted" in log.action_type %}
                                        <span class="badge bg-danger">{{ action_display }}</span>
                                    {% elif "status" in log.action_type %}
                                        <span class="badge bg-warning">{{ action_display }}</span>
                                    {% elif "assigned" in log.action_type %}
                                        <span class="badge bg-info">{{ action_display }}</span>
                                    {% elif "uploaded" in log.action_type %}
                                        <span class="badge bg-light text-dark">{{ action_display }}</span>
                                    {% elif "review" in log.action_type %}
                                        <span class="badge bg-secondary">{{ action_display }}</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">{{ action_display }}</span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                <small>{{ log.description }}</small>
                                {% if log.ip_address %}
                                    <br>
                                    <small class="text-muted">IP: {{ log.ip_address }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.case %}
                                    <a href="{% url 'cases:case_detail' log.case.id %}" class="text-decoration-none">
                                        #{{ log.case.id }}
                                    </a>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'view_audit_log' %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                No audit log entries found
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1&{{ request.GET.urlencode }}">First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page|add:'-1' }}&{{ request.GET.urlencode }}">Previous</a>
                    </li>
                {% endif %}

                {% for p in page_numbers %}
                    {% if p == '...' %}
                        <li class="page-item disabled">
                            <span class="page-link">{{ p }}</span>
                        </li>
                    {% elif p == page %}
                        <li class="page-item active">
                            <span class="page-link">{{ p }}</span>
                        </li>
                    {% else %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ p }}&{{ request.GET.urlencode }}">{{ p }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page|add:'1' }}&{{ request.GET.urlencode }}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ total_pages }}&{{ request.GET.urlencode }}">Last</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    {% endif %}
</div>

<style>
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    .badge {
        font-size: 0.85rem;
        padding: 0.4rem 0.6rem;
    }
</style>
{% endblock %}
