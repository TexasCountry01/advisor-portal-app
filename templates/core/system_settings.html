{% extends 'base.html' %}
{% load static %}

{% block title %}System Settings - Advisor Portal{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>System Settings</h1>
            <p class="text-muted">Configure global system parameters (Admin Only)</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'cases:admin_dashboard' %}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" id="settingsForm">
        {% csrf_token %}

        <!-- Nav Tabs -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="credits-tab" data-bs-toggle="tab" data-bs-target="#credits" type="button" role="tab" aria-controls="credits" aria-selected="true">
                    <i class="bi bi-coin"></i> Credits Management
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="case-settings-tab" data-bs-toggle="tab" data-bs-target="#case-settings" type="button" role="tab" aria-controls="case-settings" aria-selected="false">
                    <i class="bi bi-sliders"></i> Case Defaults
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="release-tab" data-bs-toggle="tab" data-bs-target="#release" type="button" role="tab" aria-controls="release" aria-selected="false">
                    <i class="bi bi-calendar-event"></i> Release Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api" type="button" role="tab" aria-controls="api" aria-selected="false">
                    <i class="bi bi-cloud-check"></i> API Configuration
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Credits Management Tab -->
            <div class="tab-pane fade show active" id="credits" role="tabpanel" aria-labelledby="credits-tab">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Available Credit Values</h5>
                        
                        <div class="mb-3">
                            <label for="available_credits" class="form-label">
                                Available Credits <span class="text-danger">*</span>
                                <span class="badge bg-info ms-2">Comma-separated</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="available_credits" 
                                   name="available_credits"
                                   value="{{ settings.available_credits }}"
                                   placeholder="0.5,1.0,1.5,2.0,2.5,3.0"
                                   required>
                            <small class="text-muted">
                                Technicians can assign these credit values to cases based on complexity.
                                <br>Default: 0.5 (partial report), 1.0 (single report), 1.5-3.0 (multiple scenarios)
                            </small>
                        </div>

                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle"></i> <strong>Credit Assignment Examples:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Single report: 1.0 credit</li>
                                <li>2 scenarios: 1.5 credits (1.0 base + 0.5)</li>
                                <li>3 scenarios: 2.0 credits (1.0 base + 0.5 + 0.5)</li>
                                <li>4+ scenarios: 2.5-3.0 credits</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Case Defaults Tab -->
            <div class="tab-pane fade" id="case-settings" role="tabpanel" aria-labelledby="case-settings-tab">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Default Case Settings</h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="default_case_due_days" class="form-label">
                                        Default Case Due Date (Days)
                                        <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="default_case_due_days" 
                                           name="default_case_due_days"
                                           value="{{ settings.default_case_due_days }}"
                                           min="1"
                                           max="90"
                                           required>
                                    <small class="text-muted">Number of days from submission date (1-90)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="rush_case_threshold_days" class="form-label">
                                        Rush Case Threshold (Days)
                                        <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="rush_case_threshold_days" 
                                           name="rush_case_threshold_days"
                                           value="{{ settings.rush_case_threshold_days }}"
                                           min="1"
                                           max="90"
                                           required>
                                    <small class="text-muted">Cases with fewer days marked as "Rush"</small>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle"></i> <strong>Example:</strong>
                            If default is 7 days and rush threshold is 7 days:
                            <ul class="mb-0 mt-2">
                                <li>Due date ‚â• 7 days = Standard priority</li>
                                <li>Due date &lt; 7 days = Rush priority (may incur additional charges)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Release Settings Tab -->
            <div class="tab-pane fade" id="release" role="tabpanel" aria-labelledby="release-tab">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Case Completion & Release Configuration</h5>
                        
                        <!-- Default Completion Delay -->
                        <div class="mb-4 p-3 bg-light rounded">
                            <h6 class="mb-3">Default Member Release Delay</h6>
                            <p class="text-muted small">When a technician marks a case as completed, how long should the member wait to see it?</p>
                            
                            <div class="mb-3">
                                <label for="default_completion_delay_hours" class="form-label">
                                    Default Delay (Hours, CST)
                                    <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" 
                                        id="default_completion_delay_hours" 
                                        name="default_completion_delay_hours"
                                        required>
                                    <option value="0" {% if settings.default_completion_delay_hours == 0 %}selected{% endif %}>
                                        Immediately (0 hours) - Show right away
                                    </option>
                                    <option value="1" {% if settings.default_completion_delay_hours == 1 %}selected{% endif %}>
                                        1 Hour Delay - Let member know it's coming
                                    </option>
                                    <option value="2" {% if settings.default_completion_delay_hours == 2 %}selected{% endif %}>
                                        2 Hours Delay - Standard hold period
                                    </option>
                                    <option value="3" {% if settings.default_completion_delay_hours == 3 %}selected{% endif %}>
                                        3 Hours Delay - Quality review period
                                    </option>
                                    <option value="4" {% if settings.default_completion_delay_hours == 4 %}selected{% endif %}>
                                        4 Hours Delay - Extended hold
                                    </option>
                                    <option value="5" {% if settings.default_completion_delay_hours == 5 %}selected{% endif %}>
                                        5 Hours Delay - Maximum hold
                                    </option>
                                </select>
                                <small class="text-muted d-block mt-2">
                                    <i class="bi bi-info-circle"></i> All times use Central Standard Time (CST).
                                    Technicians can override this default when completing each case.
                                </small>
                            </div>
                        </div>

                        <hr>

                        <!-- Scheduled Release Settings -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="enable_scheduled_releases" 
                                       name="enable_scheduled_releases"
                                       {% if settings.enable_scheduled_releases %}checked{% endif %}>
                                <label class="form-check-label" for="enable_scheduled_releases">
                                    <strong>Enable Scheduled Releases</strong>
                                </label>
                            </div>
                            <small class="text-muted d-block mt-1">Allow technicians to schedule delayed releases for cases</small>
                        </div>

                        <hr>

                        <!-- Batch Processing -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="batch_release_time" class="form-label">
                                        <strong>Batch Release Processing Time (UTC)</strong>
                                    </label>
                                    <input type="time" 
                                           class="form-control" 
                                           id="batch_release_time" 
                                           name="batch_release_time"
                                           value="{{ settings.batch_release_time }}">
                                    <small class="text-muted">
                                        Time of day (in UTC) to automatically process all scheduled releases.
                                        <br><em>Note: Individual case delays are calculated in CST, not UTC.</em>
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check form-switch mt-4">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="batch_release_enabled" 
                                               name="batch_release_enabled"
                                               {% if settings.batch_release_enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="batch_release_enabled">
                                            <strong>Enable Automated Batch Processing</strong>
                                        </label>
                                    </div>
                                    <small class="text-muted d-block">
                                        Automatically process all eligible scheduled releases at the specified time via cron job
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-4" role="alert">
                            <i class="bi bi-info-circle"></i> <strong>Release Delay Overview:</strong>
                            <ul class="mb-0 mt-2">
                                <li><strong>Immediately:</strong> Case shows to member right away (useful for urgent cases)</li>
                                <li><strong>1-2 Hour Delay:</strong> Brief hold for initial quality checks or notifications</li>
                                <li><strong>3-5 Hour Delay:</strong> Extended review period or coordinated release times</li>
                                <li><strong>Custom Dates:</strong> Use the "Release Date Picker" option for specific future dates</li>
                            </ul>
                        </div>

                        <div class="alert alert-warning mt-3" role="alert">
                            <i class="bi bi-exclamation-triangle"></i> <strong>Timezone Important:</strong>
                            <br>All hour-based delays are calculated using <strong>Central Standard Time (CST)</strong>, not server time.
                            The batch processing time is in UTC and needs to be scheduled via cron job.
                        </div>

                        <hr class="my-4">

                        <!-- Email Notification Settings -->
                        <h6 class="mb-3 mt-4"><i class="bi bi-envelope"></i> Member Email Notifications</h6>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="enable_delayed_email_notifications" 
                                       name="enable_delayed_email_notifications"
                                       {% if settings.enable_delayed_email_notifications %}checked{% endif %}>
                                <label class="form-check-label" for="enable_delayed_email_notifications">
                                    <strong>Enable Delayed Email Notifications</strong>
                                </label>
                            </div>
                            <small class="text-muted d-block mt-1">Send members notification emails when their cases are released/completed</small>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="default_email_delay_hours" class="form-label">
                                        <strong>Default Email Delay</strong>
                                    </label>
                                    <select class="form-select" id="default_email_delay_hours" name="default_email_delay_hours">
                                        <option value="0" {% if settings.default_email_delay_hours == 0 %}selected{% endif %}>
                                            Immediately
                                        </option>
                                        <option value="1" {% if settings.default_email_delay_hours == 1 %}selected{% endif %}>
                                            1 Hour Delay
                                        </option>
                                        <option value="2" {% if settings.default_email_delay_hours == 2 %}selected{% endif %}>
                                            2 Hours Delay
                                        </option>
                                        <option value="3" {% if settings.default_email_delay_hours == 3 %}selected{% endif %}>
                                            3 Hours Delay
                                        </option>
                                        <option value="4" {% if settings.default_email_delay_hours == 4 %}selected{% endif %}>
                                            4 Hours Delay
                                        </option>
                                        <option value="5" {% if settings.default_email_delay_hours == 5 %}selected{% endif %}>
                                            5 Hours Delay
                                        </option>
                                        <option value="6" {% if settings.default_email_delay_hours == 6 %}selected{% endif %}>
                                            6 Hours Delay
                                        </option>
                                        <option value="12" {% if settings.default_email_delay_hours == 12 %}selected{% endif %}>
                                            12 Hours Delay
                                        </option>
                                        <option value="24" {% if settings.default_email_delay_hours == 24 %}selected{% endif %}>
                                            24 Hours Delay
                                        </option>
                                    </select>
                                    <small class="text-muted">
                                        Default delay before sending member notification email (0-24 hours, CST).
                                        Technicians can override this when completing each case.
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check form-switch mt-4">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="batch_email_enabled" 
                                               name="batch_email_enabled"
                                               {% if settings.batch_email_enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="batch_email_enabled">
                                            <strong>Enable Automated Email Sending</strong>
                                        </label>
                                    </div>
                                    <small class="text-muted d-block">
                                        Automatically send scheduled emails via daily/hourly cron job
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="reply_email_address" class="form-label">
                                        <strong>Reply-To Email Address</strong>
                                    </label>
                                    <input type="email" class="form-control" id="reply_email_address" name="reply_email_address" 
                                           value="{{ settings.reply_email_address }}" 
                                           placeholder="reports@profeds.com">
                                    <small class="text-muted">Email address to use as Reply-To in member notifications. Admin only.</small>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-3" role="alert">
                            <i class="bi bi-info-circle"></i> <strong>Email Notification Info:</strong>
                            <ul class="mb-0 mt-2 ms-3">
                                <li><strong>Email Delay Tied to Release:</strong> Emails send on the same date/time as the case is released</li>
                                <li><strong>Member Email:</strong> Pulled from member profile (future: WP Fusion integration)</li>
                                <li><strong>Notification Contains:</strong> Case ID, employee name, completion date, and link to case</li>
                                <li><strong>Staff Visibility:</strong> Technicians, managers, and admins see notification status on case detail page</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Configuration Tab -->
            <div class="tab-pane fade" id="api" role="tabpanel" aria-labelledby="api-tab">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Benefits-Software API Configuration</h5>
                        
                        <div class="alert alert-warning" role="alert">
                            <i class="bi bi-exclamation-triangle"></i> <strong>Placeholder Configuration</strong>
                            <br>These settings are placeholders for future Benefits-Software API integration.
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="benefits_software_api_enabled" 
                                       name="benefits_software_api_enabled"
                                       {% if settings.benefits_software_api_enabled %}checked{% endif %}>
                                <label class="form-check-label" for="benefits_software_api_enabled">
                                    Enable Benefits-Software API Integration
                                </label>
                            </div>
                            <small class="text-muted d-block mt-1">(Currently disabled - placeholder for future use)</small>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label for="benefits_software_api_url" class="form-label">
                                API Endpoint URL
                            </label>
                            <input type="url" 
                                   class="form-control" 
                                   id="benefits_software_api_url" 
                                   name="benefits_software_api_url"
                                   value="{{ settings.benefits_software_api_url }}"
                                   placeholder="https://api.benefits-software.com/v1">
                            <small class="text-muted">Base URL for Benefits-Software API</small>
                        </div>

                        <div class="mb-3">
                            <label for="benefits_software_api_key" class="form-label">
                                API Key / Authentication Token
                            </label>
                            <input type="password" 
                                   class="form-control" 
                                   id="benefits_software_api_key" 
                                   name="benefits_software_api_key"
                                   value="{{ settings.benefits_software_api_key }}"
                                   placeholder="Enter API key (hidden for security)">
                            <small class="text-muted">Secure authentication credential for API requests</small>
                        </div>

                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle"></i> <strong>Integration Status:</strong>
                            <ul class="mb-0 mt-2">
                                <li>‚úÖ Case ID generation: Ready</li>
                                <li>‚è≥ Case submission: Placeholder configured</li>
                                <li>‚è≥ Report generation: Placeholder configured</li>
                                <li>üîí API credentials: Securely stored</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="mt-4">
            <div class="row">
                <div class="col-md-12">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-check-circle"></i> Save Settings
                    </button>
                    <a href="{% url 'cases:admin_dashboard' %}" class="btn btn-secondary btn-lg ms-2">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                </div>
            </div>
        </div>

        <!-- Last Updated Info -->
        {% if settings.updated_at %}
        <div class="alert alert-light mt-4 border" role="alert">
            <small class="text-muted">
                <i class="bi bi-clock-history"></i> Last updated: {{ settings.updated_at|date:"M d, Y H:i:s" }} UTC
                {% if settings.updated_by %}
                    by <strong>{{ settings.updated_by.get_full_name|default:settings.updated_by.username }}</strong>
                {% endif %}
            </small>
        </div>
        {% endif %}
    </form>
</div>

<style>
    .nav-link {
        padding: 12px 16px;
        border-radius: 6px 6px 0 0;
    }
    
    .nav-link.active {
        background-color: #0d6efd;
        color: white;
    }
    
    .card {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    }
    
    .tab-content {
        background-color: #f8f9fa;
        padding: 24px;
        border-radius: 0 0 8px 8px;
    }
    
    .btn-lg {
        padding: 12px 24px;
        font-weight: 500;
    }
</style>
{% endblock %}
