{% extends "base.html" %}
{% load static %}

{% block title %}Review & Accept Case - {{ case.external_case_id }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-clipboard-check"></i> Review & Accept Case</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Case ID:</strong> <code>{{ case.external_case_id }}</code></p>
                            <p><strong>Workshop Code:</strong> {{ case.workshop_code }}</p>
                            <p><strong>Member (Advisor):</strong> {{ case.member.get_full_name }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Employee:</strong> {{ case.employee_first_name }} {{ case.employee_last_name }}</p>
                            <p><strong>Submitted:</strong> {{ case.date_submitted|date:"M d, Y g:i A" }}</p>
                            <p><strong>Status:</strong> <span class="badge bg-warning">{{ case.get_status_display }}</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Review Items -->
        <div class="col-md-8">
            <!-- Federal Fact Finder Section -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-file-text"></i> Federal Fact Finder (FFF)</h5>
                </div>
                <div class="card-body">
                    {% if case.fact_finder_data %}
                        <div class="form-group mb-3">
                            <label><strong>FFF Sections Submitted:</strong></label>
                            <div class="list-group">
                                {% for section, data in case.fact_finder_data.items %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>
                                            <i class="bi bi-check-circle text-success"></i>
                                            {{ section|title }}
                                        </span>
                                        {% if data %}
                                            <span class="badge bg-success">Filled</span>
                                        {% else %}
                                            <span class="badge bg-warning">Empty</span>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> <strong>Reviewer:</strong> Verify that all required sections are completed and data appears valid.
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> No Federal Fact Finder data submitted yet.
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Documents Section -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-file-earmark"></i> Supporting Documents ({{ case.documents.count }})</h5>
                </div>
                <div class="card-body">
                    {% if case.documents.all %}
                        <div class="list-group">
                            {% for doc in case.documents.all %}
                                <div class="list-group-item d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="bi bi-file-pdf text-danger"></i>
                                            {{ doc.file|truncatechars:50 }}
                                        </h6>
                                        <small class="text-muted">
                                            Uploaded: {{ doc.uploaded_at|date:"M d, Y" }} ({{ doc.get_document_type_display }})
                                        </small>
                                    </div>
                                    <a href="{{ doc.file.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="bi bi-download"></i> View
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> <strong>No supporting documents submitted.</strong><br>
                            Required: Pay stub, TSP statement, Social Security statement
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Completeness Checklist -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-clipboard2-check"></i> Pre-Acceptance Checklist</h5>
                </div>
                <div class="card-body">
                    <form id="completenessForm">
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input completeness-item" id="check_fff" name="check_fff">
                            <label class="form-check-label" for="check_fff">
                                Federal Fact Finder has all required sections
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input completeness-item" id="check_docs" name="check_docs">
                            <label class="form-check-label" for="check_docs">
                                At least one supporting document attached
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input completeness-item" id="check_credit" name="check_credit">
                            <label class="form-check-label" for="check_credit">
                                Credit value reviewed and confirmed
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input completeness-item" id="check_tier" name="check_tier">
                            <label class="form-check-label" for="check_tier">
                                Case tier assigned
                            </label>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Check all items before accepting case.
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column: Configuration -->
        <div class="col-md-4">
            <!-- Credit Value -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-currency-dollar"></i> Credit Value</h5>
                </div>
                <div class="card-body">
                    <form id="creditForm">
                        <div class="form-group mb-3">
                            <label for="creditValue" class="form-label"><strong>Assign Credit</strong></label>
                            <select class="form-select form-select-lg" id="creditValue" name="credit_value" required>
                                <option value="">Select credit value...</option>
                                <option value="0.5" {% if case.credit_value == "0.5" %}selected{% endif %}>0.5 Credits</option>
                                <option value="1.0" {% if case.credit_value == "1.0" %}selected{% endif %}>1.0 Credit</option>
                                <option value="1.5" {% if case.credit_value == "1.5" %}selected{% endif %}>1.5 Credits</option>
                                <option value="2.0" {% if case.credit_value == "2.0" %}selected{% endif %}>2.0 Credits</option>
                                <option value="2.5" {% if case.credit_value == "2.5" %}selected{% endif %}>2.5 Credits</option>
                                <option value="3.0" {% if case.credit_value == "3.0" %}selected{% endif %}>3.0 Credits</option>
                            </select>
                            <small class="form-text text-muted">Current: {{ case.credit_value|default:"Not set" }}</small>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tier Assignment -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-layers"></i> Case Tier</h5>
                </div>
                <div class="card-body">
                    <form id="tierForm">
                        <div class="form-group mb-3">
                            <label for="caseT" class="form-label"><strong>Assign Tier</strong></label>
                            <select class="form-select form-select-lg" id="caseTier" name="tier" required>
                                <option value="">Select tier...</option>
                                <option value="tier_1" {% if case.tier == "tier_1" %}selected{% endif %}>Tier 1 (Simple)</option>
                                <option value="tier_2" {% if case.tier == "tier_2" %}selected{% endif %}>Tier 2 (Moderate)</option>
                                <option value="tier_3" {% if case.tier == "tier_3" %}selected{% endif %}>Tier 3 (Complex)</option>
                            </select>
                            <small class="form-text text-muted">Current: {{ case.get_tier_display|default:"Not set" }}</small>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Tier determines required review level.
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tech Assignment -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-person-badge"></i> Assign To Technician</h5>
                </div>
                <div class="card-body">
                    <form id="assignForm">
                        <div class="form-group mb-3">
                            <label for="assignedTo" class="form-label"><strong>Select Technician</strong></label>
                            <select class="form-select form-select-lg" id="assignedTo" name="assigned_to" required>
                                <option value="">Choose technician...</option>
                                {% for tech in available_techs %}
                                    <option value="{{ tech.id }}" data-level="{{ tech.user_level }}" {% if case.assigned_to.id == tech.id %}selected{% endif %}>
                                        {{ tech.get_full_name }} ({{ tech.get_user_level_display }})
                                    </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Case will appear in technician's queue</small>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="card mb-4 border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-check-square"></i> Decision</h5>
                </div>
                <div class="card-body d-grid gap-2">
                    <button id="acceptBtn" class="btn btn-success btn-lg" onclick="acceptCase()">
                        <i class="bi bi-check-circle"></i> Accept & Assign
                    </button>
                    <button id="rejectBtn" class="btn btn-warning btn-lg" data-bs-toggle="modal" data-bs-target="#rejectModal">
                        <i class="bi bi-x-circle"></i> Request More Info
                    </button>
                    <a href="{% url 'case_detail' case.id %}" class="btn btn-outline-secondary btn-lg">
                        <i class="bi bi-arrow-left"></i> Cancel
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Request More Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="rejectForm" method="post" action="{% url 'reject_case' case.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label for="rejectionReason" class="form-label"><strong>Primary Reason</strong></label>
                        <select class="form-select form-select-lg" id="rejectionReason" name="rejection_reason" required>
                            <option value="">Select a reason...</option>
                            <option value="incomplete_fff">Federal Fact Finder incomplete - missing required sections</option>
                            <option value="missing_documents">Missing required source documents</option>
                            <option value="insufficient_data">Insufficient data to process</option>
                            <option value="invalid_credit_request">Credit value appears incorrect</option>
                            <option value="tier_mismatch">Case tier does not match employee situation</option>
                            <option value="other">Other (please explain below)</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label for="rejectionNotes" class="form-label"><strong>Detailed Notes</strong></label>
                        <textarea class="form-control" id="rejectionNotes" name="rejection_notes" rows="5" placeholder="Explain what needs to be fixed or clarified..." required></textarea>
                        <small class="form-text text-muted">This will be sent to the advisor to address before resubmission.</small>
                    </div>
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle"></i> An email notification will be sent to {{ case.member.get_full_name }} with these details.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-send"></i> Send & Request Info
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Tier level mapping for validation
const tierLevels = {
    'tier_1': 1,
    'tier_2': 2,
    'tier_3': 3,
};

const techLevels = {
    'level_1': 1,
    'level_2': 2,
    'level_3': 3,
};

function acceptCase() {
    // Check completeness - show detailed feedback
    const completenessItems = document.querySelectorAll('.completeness-item');
    const uncheckedItems = [];
    
    completenessItems.forEach(item => {
        if (!item.checked) {
            const label = document.querySelector(`label[for="${item.id}"]`);
            uncheckedItems.push(label ? label.textContent.trim() : item.id);
        }
    });
    
    if (uncheckedItems.length > 0) {
        const itemList = uncheckedItems.map((item, idx) => `${idx + 1}. ${item}`).join('\n');
        alert('⚠️ Please check ALL items in the Pre-Acceptance Checklist:\n\n' + itemList);
        return;
    }

    // Get selected values
    const creditValue = document.getElementById('creditValue').value;
    const caseTier = document.getElementById('caseTier').value;
    const assignedTechId = document.getElementById('assignedTo').value;
    const techElement = document.querySelector(`[id="assignedTo"] option[value="${assignedTechId}"]`);
    const techLevel = techElement ? techElement.dataset.level : null;

    // Validate credit and tier are selected
    if (!creditValue) {
        alert('❌ Please select a credit value.');
        return;
    }
    if (!caseTier) {
        alert('❌ Please assign a case tier.');
        return;
    }
    if (!assignedTechId || !techLevel) {
        alert('❌ Please select a technician to assign this case to.');
        return;
    }

    // Tier validation - warn if tier > tech level
    const tierNum = tierLevels[caseTier] || 0;
    const techNum = techLevels[techLevel] || 0;

    if (tierNum > techNum) {
        const confirmed = confirm(
            `⚠️ TIER WARNING: This is a Tier ${tierNum} case but assigned tech is Level ${techNum}.\n\n` +
            `This case may exceed their experience level. Continue anyway?`
        );
        if (!confirmed) return;
    }

    // Submit the form
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name="csrfmiddlewaretoken"]').value);
    formData.append('credit_value', creditValue);
    formData.append('tier', caseTier);
    formData.append('assigned_to', assignedTechId);
    formData.append('action', 'accept');

    fetch('{% url "accept_case" case.id %}', {
        method: 'POST',
        body: formData,
    })
    .then(response => {
        if (response.ok) {
            window.location.href = `{% url 'case_detail' case.id %}?accepted=true`;
        } else {
            return response.json().then(data => {
                alert(`❌ Error: ${data.error || 'Failed to accept case'}`);
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ An unexpected error occurred.');
    });
}

// Update completeness check for tier when tier changes
document.getElementById('caseTier').addEventListener('change', function() {
    document.getElementById('check_tier').checked = this.value !== '';
});

// Update completeness check for credit when credit changes
document.getElementById('creditValue').addEventListener('change', function() {
    document.getElementById('check_credit').checked = this.value !== '';
});
</script>
{% endblock %}
