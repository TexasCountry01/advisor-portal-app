{% extends "base.html" %}
{% load static %}

{% block title %}Federal Fact Finder Form{% endblock %}

{% block content %}
<div class="container-fluid my-5">
    <div class="row">
        <div class="col-6">
            <h2>Federal Fact Finder Form</h2>
            <p class="text-muted">Employee: {{ case.employee_first_name }} {{ case.employee_last_name }}</p>
        </div>
        <div class="col-6 text-end">
            <a href="{% url 'cases:member_dashboard' %}" class="btn btn-secondary">
                <i class="bi bi-house"></i> Back to Dashboard
            </a>
        </div>
    </div>

    {% if show_upload_form %}
    <!-- Upload Form (No PDF uploaded yet) -->
    <div class="row mt-4">
        <div class="col-lg-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-upload"></i> Upload Federal Fact Finder Form
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        You need to upload the Federal Fact Finder PDF form. You can:
                    </p>
                    <ul>
                        <li>Download the blank template below and fill it out digitally</li>
                        <li>Print the blank template, fill it by hand, and scan it</li>
                        <li>Upload any previously filled Federal Fact Finder form</li>
                    </ul>

                    <div class="alert alert-info mt-4">
                        <h6><i class="bi bi-info-circle"></i> Download Blank Template</h6>
                        <p class="mb-0">Start by downloading the blank template to fill out:</p>
                        <a href="{% url 'cases:download_template' %}" class="btn btn-primary mt-2" download>
                            <i class="bi bi-download"></i> Download Blank Federal Fact Finder PDF
                        </a>
                    </div>

                    <hr class="my-4">

                    <form method="post" enctype="multipart/form-data" class="mt-4">
                        {% csrf_token %}
                        
                        <h6 class="mb-3">Upload Completed Form</h6>
                        
                        <div class="form-group mb-3">
                            <label for="fact_finder_file" class="form-label">
                                Select Federal Fact Finder PDF <span class="text-danger">*</span>
                            </label>
                            <input type="file" 
                                   class="form-control form-control-lg" 
                                   id="fact_finder_file" 
                                   name="fact_finder_file" 
                                   accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" 
                                   required>
                            <small class="text-muted">
                                Accepted formats: PDF, DOC, DOCX, JPG, PNG (Max 10MB)
                            </small>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-upload"></i> Upload Federal Fact Finder Form
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- Display Uploaded PDF using PDF.js -->
    <div class="row mt-4">
        <!-- Uploaded Federal Fact Finder PDF (Full Width) -->
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-file-pdf"></i> Federal Fact Finder - Uploaded Form
                    </h5>
                </div>
                <div class="card-body p-3">
                    <!-- Display uploaded Federal Fact Finder PDF using PDF.js -->
                    <div id="pdf-container" style="height: 700px; overflow: auto; border: 1px solid #ddd; background: #f9f9f9;">
                        <canvas id="pdf-canvas" style="display: block; margin: 0 auto;"></canvas>
                        <div id="pdf-loading" style="text-align: center; padding: 20px;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading PDF...</span>
                            </div>
                            <p class="text-muted mt-2">Loading PDF...</p>
                        </div>
                    </div>
                    <!-- CSS to hide the top header text of the PDF -->
                    <style>
                        #pdf-container {
                            clip-path: inset(50px 0 0 0);
                            height: calc(700px - 50px) !important;
                        }
                    </style>
                </div>
                <div class="card-footer text-center">
                    <small class="text-muted d-block">
                        Federal Fact Finder form is displayed above.
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Load PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Set up PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Load and render the PDF
        const pdfUrl = '{{ ff_document_url }}';
        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('pdf-container');
        const loadingDiv = document.getElementById('pdf-loading');
        
        pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
            loadingDiv.style.display = 'none';
            
            // Render first page
            pdf.getPage(1).then(page => {
                const scale = 1.5;
                const viewport = page.getViewport({ scale });
                
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                page.render(renderContext).promise.then(() => {
                    console.log('PDF rendered successfully');
                });
            });
        }).catch(error => {
            loadingDiv.innerHTML = '<p class="text-danger">Error loading PDF: ' + error.message + '</p>';
            console.error('PDF Error:', error);
        });
    </script>
    {% endif %}

    <!-- Back Links -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="btn-group" role="group">
                <a href="{% url 'cases:case_detail' case.id %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Case
                </a>
                <a href="{% url 'cases:member_dashboard' %}" class="btn btn-primary">
                    <i class="fas fa-home"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

{% endblock %}
