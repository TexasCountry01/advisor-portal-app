{% extends "base.html" %}
{% load static %}

{% block title %}Federal Fact Finder - Case {{ case.id }}{% endblock %}

{% block content %}
<div class="container-fluid my-5">
    <div class="row">
        <div class="col-12">
            <h2>Federal Fact Finder Form - Case #{{ case.id }}</h2>
            <p class="text-muted">Employee: {{ case.employee_first_name }} {{ case.employee_last_name }}</p>
        </div>
    </div>

    <div class="row mt-4">
        <!-- PDF Viewer with Native Browser PDF Support (Left Column) -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-file-pdf"></i> Federal Fact Finder - Fill Form Fields
                    </h5>
                </div>
                <div class="card-body p-3">
                    <!-- PDF Viewer with PDF-lib for interactive form fields -->
                    <div id="pdf-container" style="height: 700px; overflow-y: auto; border: 1px solid #ddd; background: #f0f0f0; display: none;">
                        <!-- Canvas rendered pages will go here -->
                    </div>
                    
                    <!-- Fallback: Native PDF Viewer for browsers without PDF-lib support -->
                    <div style="height: 700px; overflow: hidden; border: 1px solid #ddd; background: #f9f9f9;" id="pdf-viewer-fallback">
                        <iframe 
                            id="pdf-viewer"
                            src="{{ template_url }}" 
                            style="width: 100%; height: 100%; border: none;"
                            title="Federal Fact Finder PDF">
                        </iframe>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <a href="{{ template_url }}" class="btn btn-primary" download>
                        <i class="bi bi-download"></i> Download PDF
                    </a>
                    <small class="text-muted d-block mt-2">
                        Fill the form fields directly in the PDF above. Click "Save Draft" when done.
                    </small>
                </div>
            </div>
        </div>

        <!-- Supporting Documents Panel -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-upload"></i> Case Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <small><i class="bi bi-info-circle"></i> Fill the PDF form on the left, then save your progress here.</small>
                    </div>

                    <hr class="my-3">

                    <form method="post" class="mb-4" id="case-details-form">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="save_details">
                        
                        <h6 class="text-dark mb-3">Case Details</h6>
                        
                        <div class="form-group mb-3">
                            <label for="id_due_date" class="form-label">Due Date</label>
                            <input type="date" class="form-control" name="due_date" id="id_due_date" 
                                   value="{% if case.date_due %}{{ case.date_due|date:'Y-m-d' }}{% endif %}">
                            <small class="text-muted">When do you need this completed?</small>
                        </div>

                        <div class="form-group mb-3">
                            <label for="id_num_reports" class="form-label">Number of Reports</label>
                            <select class="form-select" name="num_reports_requested" id="id_num_reports">
                                <option value="1" {% if case.num_reports_requested == 1 %}selected{% endif %}>1 Report</option>
                                <option value="2" {% if case.num_reports_requested == 2 %}selected{% endif %}>2 Reports</option>
                                <option value="3" {% if case.num_reports_requested == 3 %}selected{% endif %}>3 Reports</option>
                                <option value="4" {% if case.num_reports_requested == 4 %}selected{% endif %}>4 Reports</option>
                                <option value="5" {% if case.num_reports_requested == 5 %}selected{% endif %}>5 Reports</option>
                            </select>
                            <small class="text-muted">How many retirement scenarios?</small>
                        </div>

                        <div class="form-group mb-3">
                            <label for="id_retirement_date" class="form-label">Retirement Date Preference</label>
                            <input type="date" class="form-control" name="retirement_date_preference" id="id_retirement_date" 
                                   value="{% if case.retirement_date_preference %}{{ case.retirement_date_preference|date:'Y-m-d' }}{% endif %}">
                            <small class="text-muted">Preferred retirement date for analysis</small>
                        </div>

                        <div class="form-group mb-3">
                            <label for="id_special_notes" class="form-label">Special Notes or Requests</label>
                            <textarea class="form-control" name="special_notes" id="id_special_notes" rows="3" placeholder="Any special instructions or requests...">{{ case.special_notes }}</textarea>
                            <small class="text-muted">Additional information for the analysis</small>
                        </div>

                        <button type="submit" class="btn btn-secondary w-100 mb-3">
                            <i class="fas fa-save"></i> Save Case Details
                        </button>
                    </form>

                    <hr class="my-3">

                    <!-- Save Draft and Submit Buttons -->
                    <div class="d-grid gap-2">
                        <button type="button" id="save-draft-btn" class="btn btn-success">
                            <i class="bi bi-floppy"></i> Save Draft
                        </button>
                        <small class="text-muted text-center">
                            <i class="bi bi-info-circle"></i> The PDF changes are automatically detected and saved
                        </small>
                        <form method="post" action="{% url 'submit_case' case.id %}" class="mb-0">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary w-100" 
                                    onclick="return confirm('Submit this case? You can still upload documents after submission.');">
                                <i class="fas fa-check-circle"></i> Submit Case
                            </button>
                        </form>
                    </div>

                    <small class="text-muted d-block text-center mt-3">
                        Status: <strong>{{ case.get_status_display }}</strong>
                    </small>

                    <hr class="my-3">

                    <!-- PDF Field Extraction Help -->
                    <div class="alert alert-warning small mb-3" id="pdf-help-alert">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Tip:</strong> Fill the PDF form above, then use the "Capture PDF Fields" button to extract and save your filled values.
                    </div>
                    
                    <button type="button" id="capture-pdf-fields-btn" class="btn btn-info w-100 mb-3">
                        <i class="bi bi-download"></i> Capture PDF Fields
                    </button>

                    <hr class="my-3">                    <!-- Upload Form -->
                    <form method="post" enctype="multipart/form-data" class="mb-4" id="document-upload-form">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="upload_document">
                        
                        <h6 class="text-dark mb-3">Supporting Documents</h6>
                        <div class="form-group mb-3">
                            <label for="id_document_type" class="form-label">Document Type</label>
                            <select class="form-select" name="document_type" id="id_document_type" required>
                                <option value="">-- Select --</option>
                                <option value="fact_finder">Completed Fact Finder</option>
                                <option value="supporting">Supporting Document</option>
                                <option value="pay_stub">Pay Stub</option>
                                <option value="tsp_statement">TSP Statement</option>
                                <option value="ss_statement">Social Security Statement</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group mb-3">
                            <label for="id_file" class="form-label">Choose File</label>
                            <input type="file" class="form-control" name="file" id="id_file" required>
                            <small class="text-muted">PDF, DOC, DOCX, JPG, PNG (Max 10MB)</small>
                        </div>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-upload"></i> Upload Document
                        </button>
                    </form>

                    <!-- Uploaded Documents -->
                    <div>
                        <h6 class="text-dark mb-3">
                            Uploaded Documents
                            {% if documents %}<span class="badge bg-primary">{{ documents.count }}</span>{% endif %}
                        </h6>
                        
                        {% if documents %}
                            <div class="list-group">
                                {% for doc in documents %}
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">
                                                    <i class="fas fa-file"></i>
                                                    {{ doc.get_document_type_display }}
                                                </h6>
                                                <small class="text-muted">
                                                    Uploaded {{ doc.uploaded_at|date:"M d, Y" }}
                                                    by {{ doc.uploaded_by.get_full_name }}
                                                </small>
                                            </div>
                                            <div class="btn-group-vertical btn-group-sm" role="group">
                                                <a href="{% url 'download_document' doc.id %}" 
                                                   class="btn btn-outline-primary" 
                                                   title="Download">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                {% if request.user == case.member or request.user.is_admin %}
                                                    <form method="post" 
                                                          action="{% url 'delete_document' doc.id %}" 
                                                          style="display: inline;"
                                                          onsubmit="return confirm('Delete this document?');">
                                                        {% csrf_token %}
                                                        <button type="submit" 
                                                                class="btn btn-outline-danger btn-sm"
                                                                title="Delete">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info small mb-0">
                                <i class="fas fa-info-circle"></i>
                                No documents uploaded yet.
                            </div>
                        {% endif %}
                    </div>

                    <!-- Action Buttons -->
                    <hr class="my-4">
                    <div class="d-grid gap-2">
                        <form method="post" action="{% url 'submit_case' case.id %}" class="mb-0">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary w-100" 
                                    onclick="return confirm('Submit this case? You can still upload documents after submission.');">
                                <i class="fas fa-check-circle"></i> Submit Case
                            </button>
                        </form>
                        <button type="submit" form="factFinderFormData" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-save"></i> Save Draft
                        </button>
                    </div>

                    <small class="text-muted d-block text-center mt-3">
                        Status: <strong>{{ case.get_status_display }}</strong>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Link -->
    <div class="row mt-4">
        <div class="col-12">
            <a href="{% url 'case_detail' case.id %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Case
            </a>
        </div>
    </div>
</div>

<!-- JavaScript for PDF Form Field Handling with Persistence -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfjs-dist/3.11.174/pdf.min.js"></script>
<script>
    const caseId = {{ case.id }};
    const pdfUrl = '{{ template_url }}';
    const savedFieldData = {{ saved_pdf_data|default:"{}"|safe }};
    
    // Global to track form field values
    let currentFormFieldValues = {};
    let pdfDocInstance = null;
    
    document.addEventListener('DOMContentLoaded', async function() {
        // Set PDF-js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdfjs-dist/3.11.174/pdf.worker.min.js';
        }
        
        // Set up Save Draft button
        document.getElementById('save-draft-btn').addEventListener('click', saveDraft);
        
        // Set up Capture PDF Fields button
        document.getElementById('capture-pdf-fields-btn').addEventListener('click', capturePDFFields);
        
        // Initialize PDF with field detection
        await initializePDFHandler();
    });

    async function initializePDFHandler() {
        try {
            // Load the PDF to get form fields structure
            const response = await fetch(pdfUrl);
            const arrayBuffer = await response.arrayBuffer();
            const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
            
            // Get form object
            const form = pdfDoc.getForm();
            const fields = form.getFields();
            
            console.log(`Detected ${fields.length} form fields in PDF`);
            
            // Map all PDF form field names
            const pdfFieldMap = {};
            fields.forEach(field => {
                const fieldName = field.getName();
                const fieldType = field.constructor.name;
                pdfFieldMap[fieldName] = {
                    type: fieldType,
                    value: ''
                };
            });
            
            console.log('PDF Form Fields available for extraction');
            window.pdfFieldMap = pdfFieldMap;
            
        } catch (error) {
            console.error('Error initializing PDF handler:', error);
        }
    }

    async function capturePDFFields() {
        try {
            // Get the iframe PDF viewer
            const iframeEl = document.getElementById('pdf-viewer');
            if (!iframeEl || !iframeEl.contentDocument) {
                alert('Error: Could not access PDF viewer');
                return;
            }
            
            // Try to extract PDF from iframe using PDF.js
            const pdfUrl_current = iframeEl.src || '{{ template_url }}';
            
            const response = await fetch(pdfUrl_current);
            const arrayBuffer = await response.arrayBuffer();
            const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
            
            // Get form fields
            const form = pdfDoc.getForm();
            const fields = form.getFields();
            
            // Extract values (note: this only gets saved values in the PDF, not live form values)
            const extractedValues = {};
            let filledFieldCount = 0;
            
            fields.forEach(field => {
                const fieldName = field.getName();
                try {
                    const value = field.getValue();
                    if (value) {
                        extractedValues[fieldName] = value;
                        filledFieldCount++;
                    }
                } catch (e) {
                    // Ignore fields we can't read
                }
            });
            
            console.log(`Extracted ${filledFieldCount} filled fields from PDF`);
            
            // If we found filled fields, save them
            if (filledFieldCount > 0) {
                // Add extracted fields to form data
                const formData = new FormData(document.getElementById('case-details-form'));
                formData.set('action', 'save_draft');
                
                // Append extracted PDF fields
                for (const [fieldName, value] of Object.entries(extractedValues)) {
                    formData.append(fieldName, value);
                }
                
                // Send to server
                const response = await fetch(`/cases/${caseId}/save-draft/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `<i class="bi bi-check-circle"></i> Captured ${filledFieldCount} PDF fields and saved! <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                    document.querySelector('.card-body').insertAdjacentElement('afterbegin', alertDiv);
                    
                    setTimeout(() => alertDiv.remove(), 4000);
                } else {
                    alert('Error saving captured fields');
                }
            } else {
                alert('No filled fields found in PDF. Fill the form above and try again.');
            }
            
        } catch (error) {
            console.error('Error capturing PDF fields:', error);
            alert('Error: Could not capture PDF fields. ' + error.message);
        }
    }

    async function saveDraft() {
        const form = document.getElementById('case-details-form');
        const formData = new FormData(form);
        
        // Update action
        formData.set('action', 'save_draft');
        
        try {
            const response = await fetch(`/cases/${caseId}/save-draft/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `<i class="bi bi-check-circle"></i> Draft saved successfully! (${data.saved_fields} fields) <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                document.querySelector('.card-body').insertAdjacentElement('afterbegin', alertDiv);
                
                // Auto-dismiss after 4 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 4000);
            } else {
                alert('Error saving draft: ' + (data.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error saving draft:', error);
            alert('Error saving draft. Please try again.');
        }
    }
</script>

{% endblock %}
