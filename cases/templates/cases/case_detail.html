{% extends 'base.html' %}

{% block title %}Case {{ case.external_case_id }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        {% if user.role == 'member' %}
                            <a href="{% url 'cases:member_dashboard' %}">Dashboard</a>
                        {% elif user.role == 'technician' %}
                            <a href="{% url 'cases:technician_dashboard' %}">Dashboard</a>
                        {% else %}
                            <a href="{% url 'cases:case_list' %}">Cases</a>
                        {% endif %}
                    </li>
                    <li class="breadcrumb-item active">{{ case.employee_first_name }} {{ case.employee_last_name }}</li>
                </ol>
            </nav>
            <h2>{{ case.employee_first_name }} {{ case.employee_last_name }}</h2>
        </div>
        <div class="col-auto d-flex align-items-center gap-2">
            {% if user.role == 'member' %}
                {% if case.status == 'draft' %}
                    <span class="badge bg-secondary fs-5">Draft</span>
                {% elif case.status == 'submitted' %}
                    <span class="badge bg-primary fs-5">Submitted</span>
                {% elif case.status == 'resubmitted' %}
                    <span class="badge bg-info fs-5">Resubmitted</span>
                {% elif case.status == 'accepted' %}
                    <span class="badge bg-success fs-5">Accepted</span>
                {% elif case.status == 'pending_review' %}
                    <span class="badge bg-warning fs-5">Pending Review</span>
                {% elif case.status == 'completed' %}
                    <span class="badge bg-success fs-5">Completed</span>
                {% else %}
                    <span class="badge bg-secondary fs-5">{{ case.get_status_display }}</span>
                {% endif %}
            {% elif user.role == 'technician' %}
                {% if case.status == 'draft' %}
                    <span class="badge bg-secondary fs-5">Draft</span>
                {% elif case.status == 'submitted' %}
                    <span class="badge bg-primary fs-5">Submitted</span>
                {% elif case.status == 'resubmitted' %}
                    <span class="badge bg-info fs-5">Resubmitted</span>
                {% elif case.status == 'accepted' %}
                    <span class="badge bg-success fs-5">Accepted</span>
                {% elif case.status == 'pending_review' %}
                    <span class="badge bg-warning fs-5">Pending Review</span>
                {% elif case.status == 'completed' %}
                    <span class="badge bg-success fs-5">Completed</span>
                {% else %}
                    <span class="badge bg-secondary fs-5">{{ case.get_status_display }}</span>
                {% endif %}
            {% else %}
                {% if case.status == 'draft' %}
                    <span class="badge bg-secondary fs-5">Draft</span>
                {% elif case.status == 'submitted' %}
                    <span class="badge bg-primary fs-5">Submitted</span>
                {% elif case.status == 'resubmitted' %}
                    <span class="badge bg-info fs-5">Resubmitted</span>
                {% elif case.status == 'accepted' %}
                    <span class="badge bg-success fs-5">Accepted</span>
                {% elif case.status == 'pending_review' %}
                    <span class="badge bg-warning fs-5">Pending Review</span>
                {% elif case.status == 'completed' %}
                    <span class="badge bg-success fs-5">Completed</span>
                {% else %}
                    <span class="badge bg-secondary fs-5">{{ case.get_status_display }}</span>
                {% endif %}
            {% endif %}
            {% if user.role == 'member' and case.status != 'submitted' %}
                <a href="{% url 'cases:edit_case' case.id %}" class="btn btn-warning">
                    <i class="bi bi-pencil"></i> Edit Case
                </a>
            {% endif %}
            {% if user.role == 'member' %}
                <a href="{% url 'cases:member_dashboard' %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            {% elif user.role == 'technician' %}
                <a href="{% url 'cases:technician_dashboard' %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            {% elif user.role == 'manager' %}
                <a href="{% url 'cases:manager_dashboard' %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            {% elif user.role == 'administrator' %}
                <a href="{% url 'cases:admin_dashboard' %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Case Information -->
        <div class="col-md-8">
            <!-- Member Information -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Member Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Member:</strong><br>
                            {{ case.member.username }}
                            {% if case.member.email %}
                                <br><small class="text-muted">{{ case.member.email }}</small>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Workshop Code:</strong><br>
                            {{ case.workshop_code }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Case Information -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Case Information</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Submitted by:</strong><br>
                            {% if case.created_by %}
                                {{ case.created_by.first_name }} {{ case.created_by.last_name }}
                            {% else %}
                                {{ case.member.first_name }} {{ case.member.last_name }}
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Case ID:</strong><br>
                            {{ case.external_case_id }}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Date Submitted:</strong><br>
                            {% if case.created_at %}
                                {{ case.created_at|date:"m/d/Y" }}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Reports requested:</strong><br>
                            {{ case.num_reports_requested }}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Date Due:</strong><br>
                            {% if case.date_due %}
                                {{ case.date_due|date:"m/d/Y" }}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Credits:</strong><br>
                            {% if case.credits_assigned %}
                                {{ case.credits_assigned }}
                                {% if case.credits_final %}<span class="text-muted">(final)</span>{% endif %}
                            {% else %}
                                <span class="text-muted">Not assigned</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Date Modified:</strong><br>
                            {% if case.updated_at %}
                                {{ case.updated_at|date:"m/d/Y" }}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Urgency:</strong><br>
                            {% if case.urgency == 'urgent' %}
                                <span class="badge bg-warning">Urgent</span>
                            {% else %}
                                <span class="badge bg-secondary">Normal</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Date Completed:</strong><br>
                            {% if case.date_completed %}
                                {{ case.date_completed|date:"m/d/Y" }}
                            {% else %}
                                <span class="text-muted">Not completed</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Status:</strong><br>
                            {% if user.role == 'member' %}
                                {% if case.status == 'draft' %}
                                    <span class="badge bg-secondary">Draft</span>
                                {% elif case.status == 'submitted' %}
                                    <span class="badge bg-primary">Submitted</span>
                                {% elif case.status == 'accepted' %}
                                    <span class="badge bg-success">Accepted</span>
                                {% elif case.status == 'pending_review' %}
                                    <span class="badge bg-warning">Pending Review</span>
                                {% elif case.status == 'completed' %}
                                    {% if case.actual_release_date %}
                                        <span class="badge bg-success">Completed</span>
                                    {% else %}
                                        <span class="badge bg-info">Working</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-secondary">{{ case.get_status_display }}</span>
                                {% endif %}
                            {% elif user.role == 'technician' %}
                                {% if case.assigned_to and case.assigned_to.id == user.id %}
                                    <span class="badge bg-info">Working</span>
                                {% else %}
                                    {% if case.status == 'draft' %}
                                        <span class="badge bg-secondary">Draft</span>
                                    {% elif case.status == 'submitted' %}
                                        <span class="badge bg-primary">Submitted</span>
                                    {% elif case.status == 'accepted' %}
                                        <span class="badge bg-success">Accepted</span>
                                    {% elif case.status == 'pending_review' %}
                                        <span class="badge bg-warning">Pending Review</span>
                                    {% elif case.status == 'completed' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ case.get_status_display }}</span>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                {% if case.status == 'draft' %}
                                    <span class="badge bg-secondary">Draft</span>
                                {% elif case.status == 'submitted' %}
                                    <span class="badge bg-primary">Submitted</span>
                                {% elif case.status == 'accepted' %}
                                    <span class="badge bg-success">Accepted</span>
                                {% elif case.status == 'pending_review' %}
                                    <span class="badge bg-warning">Pending Review</span>
                                {% elif case.status == 'completed' %}
                                    <span class="badge bg-success">Completed</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ case.get_status_display }}</span>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Member Notes to Benefits Team -->
            {% if case.special_notes %}
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Member Notes to Benefits Team</h6>
                </div>
                <div class="card-body">
                    <div class="p-3 bg-light rounded">
                        {{ case.special_notes|linebreaks }}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Release Status (if applicable) -->
            {% if case.status == 'completed' and user.role != 'member' %}
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-check"></i> Release Status
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if case.actual_release_date %}
                            <div class="alert alert-success" role="alert">
                                <i class="bi bi-check-circle"></i>
                                <strong>This case was released on:</strong><br>
                                {{ case.actual_release_date|date:"F j, Y \a\t g:i A" }}
                            </div>
                        {% elif case.scheduled_release_date %}
                            <div class="alert alert-info" role="alert">
                                <i class="bi bi-calendar-event"></i>
                                <strong>This case is scheduled to be released on:</strong><br>
                                {{ case.scheduled_release_date|date:"F j, Y" }}
                            </div>
                        {% else %}
                            <div class="alert alert-warning" role="alert">
                                <i class="bi bi-info-circle"></i>
                                <strong>This case is completed but no release date has been set.</strong>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <!-- Document Summary Alert -->
            <div class="alert alert-light border mb-4">
                <h6 class="mb-2"><i class="bi bi-file-earmark"></i> Document Summary:</h6>
                <div>
                    {% regroup documents by document_type as docs_by_type %}
                    {% for doc_type_group in docs_by_type %}
                        {% if doc_type_group.grouper == 'Federal Fact Finder' %}
                            Federal Fact Finder: {{ doc_type_group.list|length }} file(s)<br>
                        {% elif doc_type_group.grouper == 'Supporting Document' %}
                            Supporting Documents: {{ doc_type_group.list|length }} file(s)<br>
                        {% endif %}
                    {% empty %}
                        Federal Fact Finder: 0 file(s)<br>
                        Supporting Documents: 0 file(s)<br>
                    {% endfor %}
                    
                    <strong>Total: {{ documents|length }} document(s)</strong>
                </div>
            </div>

            <!-- Supporting Documents -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        Submitted Documents
                        <span class="badge bg-info">{{ documents|length }} Total</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if documents %}
                        {% regroup documents by document_type as docs_by_type %}
                        
                        <!-- Federal Fact Finder Documents -->
                        {% for doc_type_group in docs_by_type %}
                            {% if doc_type_group.grouper == 'fact_finder' %}
                            <div class="mb-4">
                                <h6 class="mb-3">
                                    <i class="bi bi-file-pdf" style="color: #dc3545;"></i> 
                                    Federal Fact Finder
                                    <span class="badge bg-primary">{{ doc_type_group.list|length }}</span>
                                </h6>
                                <div class="list-group">
                                    {% for doc in doc_type_group.list %}
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="bi bi-file-earmark-pdf"></i>
                                                {% if doc.file %}<a href="{{ doc.file.url }}" target="_blank" class="text-decoration-none">{% endif %}
                                                    <strong>{{ doc.original_filename }}</strong>
                                                {% if doc.file %}</a>{% endif %}
                                                <br><small class="text-muted">{{ doc.uploaded_at|date:"m/d/Y H:i" }}</small>
                                            </div>
                                            <div class="text-end">
                                                {% if doc.file %}<a href="{{ doc.file.url }}" class="btn btn-sm btn-outline-primary" download title="Download document">
                                                    <i class="bi bi-download"></i>
                                                </a>{% else %}<span class="badge bg-warning">No file</span>{% endif %}
                                                {% if can_edit and case.status != 'submitted' %}
                                                <form method="post" action="{% url 'cases:delete_document' doc.id %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this document?');" title="Delete document">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}

                        <!-- Supporting Documents -->
                        {% for doc_type_group in docs_by_type %}
                            {% if doc_type_group.grouper == 'supporting' %}
                            <div class="mb-4">
                                <h6 class="mb-3">
                                    <i class="bi bi-file-earmark" style="color: #6c757d;"></i> 
                                    Supporting Documents
                                    <span class="badge bg-secondary">{{ doc_type_group.list|length }}</span>
                                </h6>
                                <div class="list-group">
                                    {% for doc in doc_type_group.list %}
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="bi bi-file-earmark"></i>
                                                {% if doc.file %}<a href="{{ doc.file.url }}" target="_blank" class="text-decoration-none">{% endif %}
                                                    <strong>{{ doc.original_filename }}</strong>
                                                {% if doc.file %}</a>{% endif %}
                                                <br><small class="text-muted">{{ doc.uploaded_at|date:"m/d/Y H:i" }}</small>
                                            </div>
                                            <div class="text-end">
                                                {% if doc.file %}<a href="{{ doc.file.url }}" class="btn btn-sm btn-outline-primary" download title="Download document">
                                                    <i class="bi bi-download"></i>
                                                </a>{% else %}<span class="badge bg-warning">No file</span>{% endif %}
                                                {% if can_edit and case.status != 'submitted' %}
                                                <form method="post" action="{% url 'cases:delete_document' doc.id %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this document?');" title="Delete document">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                        
                    {% else %}
                    <p class="text-muted">No supporting documents uploaded yet. Download the Federal Fact Finder template below and upload it with your supporting documents.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Member Upload & Resubmit Section (for completed cases) -->
            {% if case.status == 'completed' and user.role == 'member' and case.member == user %}
            <div class="card mb-4 border-warning">
                <div class="card-header bg-light border-warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-upload"></i> Upload Additional Documents & Resubmit
                        </h5>
                        {% if case.resubmission_count > 0 %}
                        <span class="badge bg-info">Resubmission #{{ case.resubmission_count }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info alert-permanent mb-4" role="alert">
                        <i class="bi bi-info-circle"></i>
                        <strong>This case has been completed.</strong> 
                        If you have additional documents or information that should be reviewed, 
                        you can upload them here and resubmit the case for further processing.
                    </div>

                    <!-- Document Upload Form -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Upload Supplementary Documents</h6>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{% url 'cases:upload_member_document_completed' case.id %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="document_file" class="form-label">Select File</label>
                                    <input type="file" class="form-control" id="document_file" name="document_file" required>
                                    <small class="text-muted">
                                        Accepted formats: PDF, Word, Excel, images, etc. (Max 50MB)
                                    </small>
                                </div>
                                <div class="mb-3">
                                    <label for="document_notes" class="form-label">Document Description (Optional)</label>
                                    <textarea class="form-control" id="document_notes" name="document_notes" rows="2" placeholder="Describe what this document contains..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-upload"></i> Upload Document
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Previously Uploaded Supplementary Documents -->
                    {% with supplementary_docs=documents %}
                        {% if supplementary_docs %}
                        <div class="mb-3">
                            <h6>Supplementary Documents Uploaded</h6>
                            <div class="list-group">
                                {% for doc in supplementary_docs %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                <i class="bi bi-file-earmark"></i> {{ doc.original_filename }}
                                            </h6>
                                            <small class="text-muted">
                                                Uploaded: {{ doc.uploaded_at|date:"M d, Y \a\t g:i A" }}
                                            </small>
                                            {% if doc.notes %}
                                            <br>
                                            <small class="text-secondary">
                                                {{ doc.notes }}
                                            </small>
                                            {% endif %}
                                        </div>
                                        {% if doc.file %}
                                        <a href="{{ doc.file.url }}" class="btn btn-sm btn-outline-primary ms-2" download title="Download this document">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% endwith %}

                    <!-- Resubmit Button -->
                    <div class="mt-4 pt-3 border-top">
                        <p class="text-muted small mb-3">
                            When ready, submit the form below to resubmit this case for technician review:
                        </p>
                        <a href="{% url 'cases:resubmit_case' case.id %}" class="btn btn-warning btn-lg">
                            <i class="bi bi-arrow-repeat"></i> Resubmit Case
                        </a>
                        <p class="text-muted small mt-3 mb-0">
                            <i class="bi bi-exclamation-triangle"></i>
                            Resubmitting will change the case status back to "Submitted" and notify the assigned technician to review your documents.
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Technician/Internal Notes Section -->
            {% if user.role == 'technician' or user.role == 'administrator' or user.role == 'manager' %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-pencil-square"></i> Internal Notes/Comments
                        {% if case_notes.count > 0 %}
                        <span class="badge bg-warning">{{ case_notes.count }}</span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if case_notes %}
                    <div class="list-group mb-3">
                        {% for note in case_notes %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    {% if note.author %}
                                        <strong>{{ note.author.get_full_name|default:note.author.username }}</strong>
                                    {% else %}
                                        <strong class="text-muted">[Deleted User]</strong>
                                    {% endif %}
                                    <small class="text-muted d-block">{{ note.created_at|date:"m/d/Y H:i" }}</small>
                                </div>
                                {% if note.author and user.id == note.author.id or user.role == 'administrator' %}
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteNote({{ note.id }}, {{ case.id }})" title="Delete this note">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                            <p class="mt-2 mb-0">{{ note.note|linebreaks }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-3">No internal notes yet.</p>
                    {% endif %}

                    {% if can_edit %}
                    <form method="post" action="{% url 'cases:add_case_note' case.id %}" class="mt-3">
                        {% csrf_token %}
                        <div class="form-group">
                            <textarea class="form-control" name="notes" rows="3" placeholder="Add an internal note..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus-circle"></i> Add Note
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Reports -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        Reports
                        {% if case.reports.count > 0 %}
                        <span class="badge bg-info">{{ case.reports.count }}</span>
                        {% endif %}
                    </h5>
                    {% if can_upload_reports %}
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadReportModal">
                        <i class="bi bi-upload"></i> Upload Report
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if case.reports.all %}
                    <div class="list-group">
                        {% for report in case.reports.all %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    {% if report.report_file %}
                                    <i class="bi bi-file-earmark"></i>
                                    <a href="{{ report.report_file.url }}" target="_blank" class="text-decoration-none">
                                        <strong>Report #{{ report.report_number }}</strong>
                                    </a>
                                    {% else %}
                                    <i class="bi bi-file-earmark"></i>
                                    <strong>Report #{{ report.report_number }}</strong>
                                    {% endif %}
                                    <br><small class="text-muted">
                                        Status: <span class="badge bg-secondary">{{ report.get_status_display }}</span>
                                        {% if report.notes %}| Notes: {{ report.notes|truncatewords:10 }}{% endif %}
                                    </small>
                                </div>
                                <div class="text-end">
                                    {% if report.report_file %}
                                    <a href="{{ report.report_file.url }}" class="btn btn-sm btn-outline-primary" download>
                                        <i class="bi bi-download"></i>
                                    </a>
                                    {% endif %}
                                    <br><small class="text-muted">{{ report.updated_at|date:"m/d/Y H:i" }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">No reports uploaded yet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Additional Documents -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Additional Documents</h5>
                    {% if can_edit %}
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadTechDocModal">
                        <i class="bi bi-upload"></i> Upload Document
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if tech_documents %}
                    <div class="list-group">
                        {% for doc in tech_documents %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <i class="bi bi-file-earmark"></i>
                                    <a href="{{ doc.file.url }}" target="_blank" class="text-decoration-none">
                                        <strong>{{ doc.original_filename }}</strong>
                                    </a>
                                    <br><small class="text-muted">
                                        {% if doc.notes %}{{ doc.notes|truncatewords:15 }}<br>{% endif %}
                                        Uploaded by {{ doc.uploaded_by.get_full_name|default:doc.uploaded_by.username }} on {{ doc.uploaded_at|date:"m/d/Y H:i" }}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <a href="{{ doc.file.url }}" class="btn btn-sm btn-outline-primary" download>
                                        <i class="bi bi-download"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">No technician documents uploaded yet. Click "Upload Document" to add supporting files.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column: Timeline & Actions (Technician/Admin only) -->
        <div class="col-md-4">
            {% if user.role != 'member' %}
                <!-- Assignment -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Assignment</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Assigned To:</strong><br>
                            {% if case.assigned_to %}
                                {{ case.assigned_to.username }}
                                <br><small class="text-muted">{{ case.assigned_to.user_level }}</small>
                            {% else %}
                                <span class="text-muted">Unassigned</span>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <strong>Reviewed By:</strong><br>
                            {% if case.reviewed_by %}
                                {{ case.reviewed_by.username }}
                                <br><small class="text-muted">{{ case.reviewed_by.user_level }}</small>
                            {% else %}
                                <span class="text-muted">Not reviewed</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Timeline</h5>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            <div class="timeline-item">
                                <strong>Submitted:</strong><br>
                                {{ case.date_submitted|date:"m/d/Y H:i" }}
                            </div>
                            {% if case.date_accepted %}
                            <div class="timeline-item">
                                <strong>Accepted:</strong><br>
                                {{ case.accepted_at|date:"m/d/Y H:i" }}
                            </div>
                            {% endif %}
                            {% if case.date_completed %}
                            <div class="timeline-item">
                                <strong>Completed:</strong><br>
                                {{ case.date_completed|date:"m/d/Y H:i" }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            {% if case.assigned_to == user %}
                                {% if case.status == 'completed' %}
                                    <button type="button" class="btn btn-secondary" id="markCompletedBtn" onclick="markCaseIncomplete()">
                                        <i class="bi bi-arrow-counterclockwise"></i> Mark as Incomplete
                                    </button>
                                    <p class="text-muted small mt-2 mb-0">
                                        <i class="bi bi-info-circle"></i> This case was completed on {{ case.date_completed|date:"m/d/Y H:i" }}
                                    </p>
                                {% else %}
                                    <button type="button" class="btn btn-success" id="markCompletedBtn" onclick="markCaseCompleted()">
                                        <i class="bi bi-check-circle"></i> Mark as Completed
                                    </button>
                                    <button class="btn btn-warning" disabled>
                                        <i class="bi bi-pause-circle"></i> Put on Hold
                                    </button>
                                    <button class="btn btn-primary" disabled>
                                        <i class="bi bi-arrow-right-circle"></i> Submit for Review
                                    </button>
                                    <hr>
                                    <small class="text-muted" id="actionHelp">
                                        <i class="bi bi-info-circle"></i> At least one report must be uploaded before marking as completed.
                                    </small>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle"></i> You have not taken ownership of this case. Case actions are only available to the assigned technician.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Upload Report Modal -->
<div class="modal fade" id="uploadReportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'cases:upload_case_report' case.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="reportNumber" class="form-label">Report Number <span class="text-danger">*</span></label>
                        <select class="form-select" id="reportNumber" name="report_number" required>
                            <option value="">-- Select Report Number --</option>
                            {% for i in case.get_report_numbers %}
                            <option value="{{ i }}">Report {{ i }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Requested: {{ case.num_reports_requested }} report{{ case.num_reports_requested|pluralize }}</small>
                    </div>
                    <div class="mb-3">
                        <label for="reportFile" class="form-label">Select File <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="reportFile" name="report_file" required>
                        <small class="text-muted">Accepts PDF, DOC, DOCX, XLS, XLSX, and other common formats</small>
                    </div>
                    <div class="mb-3">
                        <label for="reportNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="reportNotes" name="report_notes" rows="3" placeholder="Add any notes about this report..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload"></i> Upload Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Upload Technician Document Modal -->
<div class="modal fade" id="uploadTechDocModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Technician Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'cases:upload_technician_document' case.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="techDocFile" class="form-label">Select File <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="techDocFile" name="document_file" required>
                        <small class="text-muted">Accepts PDF, DOC, DOCX, XLS, XLSX, images, and other common formats</small>
                    </div>
                    <div class="mb-3">
                        <label for="techDocNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="techDocNotes" name="document_notes" rows="3" placeholder="Add any notes about this document..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload"></i> Upload Document
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Note Modal -->
<div class="modal fade" id="addNoteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Internal Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'cases:add_case_note' case.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="noteText" class="form-label">Note <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="noteText" name="notes" rows="4" placeholder="Add an internal note..." required></textarea>
                        <small class="text-muted">This note will be visible to other technicians and administrators.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add Note
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function markCaseCompleted() {
    const btn = document.getElementById('markCompletedBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Validating...';
    
    // First, validate that case can be completed
    fetch('{% url "cases:validate_case_completion" case.id %}', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (!data.valid) {
            // Validation failed
            if (data.canOverride) {
                // Show warning with override option
                const alertHtml = `
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Warning:</strong> ${data.error}
                        <hr>
                        <p class="mb-2">${data.warning}</p>
                        <button type="button" class="btn btn-sm btn-warning me-2" onclick="confirmCaseCompletionOverride()">
                            <i class="bi bi-check-circle"></i> Yes, Complete Anyway
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="alert">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                    </div>
                `;
                document.querySelector('.card-body').insertAdjacentHTML('beforebegin', alertHtml);
            } else {
                // Show hard error (no override allowed)
                const alertHtml = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-circle"></i> ${data.error}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                document.querySelector('.card-body').insertAdjacentHTML('beforebegin', alertHtml);
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Mark as Completed';
            return;
        }
        
        // Validation passed - show release options modal
        const releaseModal = new bootstrap.Modal(document.getElementById('releaseOptionsModal'));
        releaseModal.show();
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Mark as Completed';
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while validating your request.');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Mark as Completed';
    });
}

function confirmCaseCompletionOverride() {
    // User confirmed they want to override the missing reports validation
    const releaseModal = new bootstrap.Modal(document.getElementById('releaseOptionsModal'));
    releaseModal.show();
    // Store override flag for later use
    window.caseCompletionOverride = true;
}

function confirmCaseCompletion() {
    const btn = document.getElementById('confirmReleaseBtn');
    const releaseNowRadio = document.getElementById('releaseNow');
    const releaseDateInput = document.getElementById('releaseDate');
    
    let releaseOption = 'now';
    let releaseDate = null;
    
    if (!releaseNowRadio.checked) {
        releaseOption = 'schedule';
        releaseDate = releaseDateInput.value;
        
        if (!releaseDate) {
            alert('Please select a release date.');
            return;
        }
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
    
    // Proceed with marking as completed
    fetch('{% url "cases:mark_case_completed" case.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            release_option: releaseOption,
            release_date: releaseDate,
            override_incomplete: window.caseCompletionOverride || false
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle"></i> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.querySelector('.card-body').insertAdjacentHTML('beforebegin', alertHtml);
            
            // Close modal and reload the page after 2 seconds
            bootstrap.Modal.getInstance(document.getElementById('releaseOptionsModal')).hide();
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            // Show error message
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-circle"></i> ${data.error}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.querySelector('.card-body').insertAdjacentHTML('beforebegin', alertHtml);
            
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Confirm Release';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your request.');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Confirm Release';
    });
}

// Set minimum date to today + 7 days when modal is shown
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('releaseOptionsModal');
    if (modal) {
        modal.addEventListener('show.bs.modal', function() {
            const today = new Date();
            const minDate = new Date(today);
            minDate.setDate(minDate.getDate() + 1);  // Minimum 1 day from now for testing
            const dateInput = document.getElementById('releaseDate');
            const minDateStr = minDate.toISOString().split('T')[0];
            dateInput.min = minDateStr;
            dateInput.value = minDateStr;
            
            // Set max date to the case due date if it exists
            const caseDueDate = '{{ case.date_due|date:"Y-m-d" }}';
            if (caseDueDate && caseDueDate !== 'None' && caseDueDate.length > 0) {
                dateInput.max = caseDueDate;
                console.log('Date Input Min:', minDateStr);
                console.log('Date Input Max:', caseDueDate);
                // If the default date (1 day from now) is after due date, use due date instead
                if (minDateStr > caseDueDate) {
                    dateInput.value = caseDueDate;
                    console.log('Default date after due date, setting to:', caseDueDate);
                }
            } else {
                console.log('No due date set, min only:', minDateStr);
            }
        });
    }
    
    // Toggle date input based on radio selection
    const releaseNow = document.getElementById('releaseNow');
    const scheduleRelease = document.getElementById('scheduleRelease');
    const releaseDateGroup = document.getElementById('releaseDateGroup');
    
    if (releaseNow) {
        releaseNow.addEventListener('change', function() {
            if (releaseDateGroup) releaseDateGroup.style.display = 'none';
        });
    }
    
    if (scheduleRelease) {
        scheduleRelease.addEventListener('change', function() {
            if (releaseDateGroup) releaseDateGroup.style.display = 'block';
        });
    }
});

function markCaseIncomplete() {
    // Show confirmation dialog
    if (confirm('Are you sure you want to reactivate this case? It will be changed back to "Pending Review" status.')) {
        const btn = document.getElementById('markCompletedBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
        
        fetch('{% url "cases:mark_case_incomplete" case.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alertHtml = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle"></i> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                document.querySelector('.card-body').insertAdjacentHTML('beforebegin', alertHtml);
                
                // Reload the page after 2 seconds
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                // Show error message
                const alertHtml = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-circle"></i> ${data.error}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                document.querySelector('.card-body').insertAdjacentHTML('beforebegin', alertHtml);
                
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> Mark as Incomplete';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing your request.');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> Mark as Incomplete';
        });
    }
}

function deleteNote(noteId, caseId) {
    if (!confirm('Are you sure you want to delete this note? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/cases/${caseId}/delete-note/${noteId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to reflect the deletion
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete note'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the note.');
    });
}
</script>

<!-- Release Options Modal -->
<div class="modal fade" id="releaseOptionsModal" tabindex="-1" aria-labelledby="releaseOptionsLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="releaseOptionsLabel">
                    <i class="bi bi-calendar-check"></i> When should this case be released to the member?
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">Choose when the member should be able to see the completed case:</p>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="releaseOption" id="releaseNow" value="now" checked>
                    <label class="form-check-label" for="releaseNow">
                        <strong>Release Now</strong>
                        <br>
                        <small class="text-muted">Member can view the completed case immediately</small>
                    </label>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="releaseOption" id="scheduleRelease" value="schedule">
                    <label class="form-check-label" for="scheduleRelease">
                        <strong>Schedule Release</strong>
                        <br>
                        <small class="text-muted">Member will see the case on a specific date</small>
                    </label>
                </div>
                
                <div id="releaseDateGroup" style="display: none; margin-top: 20px;">
                    <label for="releaseDate" class="form-label">Release Date:</label>
                    <input type="date" class="form-control" id="releaseDate">
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle"></i> Default is 7 days from completion. You can select a later date if preferred.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmReleaseBtn" onclick="confirmCaseCompletion()">
                    <i class="bi bi-check-circle"></i> Confirm Release
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

