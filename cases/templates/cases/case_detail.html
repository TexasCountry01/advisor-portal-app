{% extends 'base.html' %}

{% block title %}Case {{ case.external_case_id }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        {% if user.role == 'member' %}
                            <a href="{% url 'cases:member_dashboard' %}">Dashboard</a>
                        {% elif user.role == 'technician' %}
                            <a href="{% url 'cases:technician_dashboard' %}">Dashboard</a>
                        {% else %}
                            <a href="{% url 'cases:case_list' %}">Cases</a>
                        {% endif %}
                    </li>
                    <li class="breadcrumb-item active">{{ case.employee_first_name }} {{ case.employee_last_name }}</li>
                </ol>
            </nav>
            <h2>{{ case.employee_first_name }} {{ case.employee_last_name }}</h2>
        </div>
        <div class="col-auto d-flex align-items-center gap-2">
            {% if user.role == 'member' %}
                {% if case.status == 'draft' %}
                    <span class="badge bg-secondary fs-5">Draft</span>
                {% elif case.status == 'submitted' %}
                    <span class="badge bg-primary fs-5">Submitted</span>
                {% elif case.status == 'resubmitted' %}
                    <span class="badge bg-info fs-5">Resubmitted</span>
                {% elif case.status == 'accepted' %}
                    <span class="badge bg-success fs-5">Accepted</span>
                {% elif case.status == 'pending_review' %}
                    <span class="badge bg-warning fs-5">Pending Review</span>
                {% elif case.status == 'completed' %}
                    <span class="badge bg-success fs-5">Completed</span>
                {% else %}
                    <span class="badge bg-secondary fs-5">{{ case.get_status_display }}</span>
                {% endif %}
            {% elif user.role == 'technician' %}
                {% if case.status == 'draft' %}
                    <span class="badge bg-secondary fs-5">Draft</span>
                {% elif case.status == 'submitted' %}
                    <span class="badge bg-primary fs-5">Submitted</span>
                {% elif case.status == 'resubmitted' %}
                    <span class="badge bg-info fs-5">Resubmitted</span>
                {% elif case.status == 'accepted' %}
                    <span class="badge bg-success fs-5">Accepted</span>
                {% elif case.status == 'pending_review' %}
                    <span class="badge bg-warning fs-5">Pending Review</span>
                {% elif case.status == 'completed' %}
                    <span class="badge bg-success fs-5">Completed</span>
                {% else %}
                    <span class="badge bg-secondary fs-5">{{ case.get_status_display }}</span>
                {% endif %}
            {% else %}
                {% if case.status == 'draft' %}
                    <span class="badge bg-secondary fs-5">Draft</span>
                {% elif case.status == 'submitted' %}
                    <span class="badge bg-primary fs-5">Submitted</span>
                {% elif case.status == 'resubmitted' %}
                    <span class="badge bg-info fs-5">Resubmitted</span>
                {% elif case.status == 'accepted' %}
                    <span class="badge bg-success fs-5">Accepted</span>
                {% elif case.status == 'pending_review' %}
                    <span class="badge bg-warning fs-5">Pending Review</span>
                {% elif case.status == 'completed' %}
                    <span class="badge bg-success fs-5">Completed</span>
                {% else %}
                    <span class="badge bg-secondary fs-5">{{ case.get_status_display }}</span>
                {% endif %}
            {% endif %}
            {% if user.role == 'member' and case.status != 'submitted' and case.status != 'draft' %}
                <a href="{% url 'cases:edit_case' case.id %}" class="btn btn-warning">
                    <i class="bi bi-pencil"></i> Edit Case
                </a>
            {% endif %}
            {% if user.role == 'member' %}
                <a href="{% url 'cases:member_dashboard' %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
                {% if case.status == 'draft' and case.member == user %}
                <button type="button" class="btn btn-warning" id="editDraftBtn" onclick="toggleEditMode()">
                    <i class="bi bi-pencil"></i> Edit Draft
                </button>
                <span id="editActions" style="display: none;">
                    <button type="button" class="btn btn-success" onclick="saveDraftChanges()">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="cancelEditMode()">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </span>
                {% endif %}
            {% elif user.role == 'technician' %}
                <a href="{% url 'cases:technician_dashboard' %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
                {% if case.status in 'submitted,resubmitted' %}
                    <a href="{% url 'cases:case_review_for_acceptance' case.id %}" class="btn btn-primary">
                        <i class="bi bi-clipboard-check"></i> Review & Accept
                    </a>
                {% elif not case.assigned_to or case.assigned_to != user %}
                <button type="button" class="btn btn-outline-success" onclick="takeOwnership({{ case.id }})">
                    <i class="bi bi-hand-thumbs-up"></i> Take Ownership
                </button>
                {% else %}
                <span class="badge bg-success">
                    <i class="bi bi-check-circle"></i> You own this case
                </span>
                {% endif %}
            {% elif user.role == 'manager' %}
                <a href="{% url 'cases:manager_dashboard' %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
                {% if case.status in 'submitted,resubmitted' %}
                    <a href="{% url 'cases:case_review_for_acceptance' case.id %}" class="btn btn-primary">
                        <i class="bi bi-clipboard-check"></i> Review & Accept
                    </a>
                {% endif %}
                {% if case.status == 'accepted' %}
                    <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#reassignModal">
                        <i class="bi bi-arrow-repeat"></i> Reassign
                    </button>
                {% endif %}
            {% elif user.role == 'administrator' %}
                <a href="{% url 'cases:admin_dashboard' %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
                {% if case.status in 'submitted,resubmitted' %}
                    <a href="{% url 'cases:case_review_for_acceptance' case.id %}" class="btn btn-primary">
                        <i class="bi bi-clipboard-check"></i> Review & Accept
                    </a>
                {% endif %}
                {% if case.status == 'accepted' %}
                    <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#reassignModal">
                        <i class="bi bi-arrow-repeat"></i> Reassign
                    </button>
                {% endif %}
                {% if not case.assigned_to or case.assigned_to != user %}
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#adminTakeOwnershipModal">
                    <i class="bi bi-person-check"></i> Take Ownership
                </button>
                {% else %}
                <span class="badge bg-success">
                    <i class="bi bi-check-circle"></i> You own this case
                </span>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Case Information -->
        <div class="col-md-8">
            <!-- Member Information -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Member Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Member:</strong><br>
                            {{ case.member.username }}
                            {% if case.member.email %}
                                <br><small class="text-muted">{{ case.member.email }}</small>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Workshop Code:</strong><br>
                            {{ case.workshop_code }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Case Information -->
            <div class="card mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Case Information</h6>
                    {% if user.role in 'technician,manager,administrator' and case.status in 'draft,submitted,accepted,pending_review' %}
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editCaseDetailsModal">
                            <i class="bi bi-pencil"></i> Edit Details
                        </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Submitted by:</strong><br>
                            {% if case.created_by %}
                                {{ case.created_by.first_name }} {{ case.created_by.last_name }}
                            {% else %}
                                {{ case.member.first_name }} {{ case.member.last_name }}
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Case ID:</strong><br>
                            {{ case.external_case_id }}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Date Submitted:</strong><br>
                            {% if case.created_at %}
                                {{ case.created_at|date:"m/d/Y" }}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Reports requested:</strong><br>
                            {% if case.status == 'draft' and user.role == 'member' and case.member == user %}
                                <span id="reportDisplay">{{ case.num_reports_requested }}</span>
                                <select id="reportEdit" name="num_reports_requested" class="form-select" style="display: none;">
                                    {% for i in "12345" %}
                                        <option value="{{ i }}" {% if case.num_reports_requested == i|add:0 %}selected{% endif %}>{{ i }}</option>
                                    {% endfor %}
                                </select>
                            {% else %}
                                {{ case.num_reports_requested }}
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Date Due:</strong><br>
                            {% if case.status == 'draft' and user.role == 'member' and case.member == user %}
                                <span id="dueDateDisplay">
                                    {% if case.date_due %}
                                        {{ case.date_due|date:"m/d/Y" }}
                                    {% else %}
                                        <span class="text-muted">Not set</span>
                                    {% endif %}
                                </span>
                                <input type="date" id="dueDateEdit" name="date_due" class="form-control" style="display: none;" value="{% if case.date_due %}{{ case.date_due|date:'Y-m-d' }}{% endif %}">
                            {% else %}
                                {% if case.date_due %}
                                    {{ case.date_due|date:"m/d/Y" }}
                                {% else %}
                                    <span class="text-muted">Not set</span>
                                {% endif %}
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Credits:</strong><br>
                            {% if user.role == 'member' %}
                                {% if case.status == 'completed' or case.status == 'released' %}
                                    {{ case.credit_value|default:"Not assigned" }}
                                {% else %}
                                    <span class="text-muted">Not visible until case released</span>
                                {% endif %}
                            {% else %}
                                <div class="d-flex align-items-center gap-2">
                                    <span id="creditDisplay">{{ case.credit_value|default:"Not assigned" }}</span>
                                    {% if case.status == 'accepted' or case.status == 'pending_review' or case.status == 'completed' %}
                                        {% if user.role == 'technician' or user.role == 'administrator' or user.role == 'manager' %}
                                            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#creditAdjustModal">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Date Modified:</strong><br>
                            {% if case.updated_at %}
                                {{ case.updated_at|date:"m/d/Y" }}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Urgency:</strong><br>
                            {% if case.urgency == 'rush' %}
                                <span class="badge">Rush</span>
                            {% else %}
                                <span class="badge bg-secondary">Normal</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Date Completed:</strong><br>
                            {% if case.date_completed %}
                                {{ case.date_completed|date:"m/d/Y" }}
                            {% else %}
                                <span class="text-muted">Not completed</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Status:</strong><br>
                            {% if user.role == 'member' %}
                                {% if case.status == 'draft' %}
                                    <span class="badge bg-secondary">Draft</span>
                                {% elif case.status == 'submitted' %}
                                    <span class="badge bg-primary">Submitted</span>
                                {% elif case.status == 'accepted' %}
                                    <span class="badge bg-success">Accepted</span>
                                {% elif case.status == 'pending_review' %}
                                    <span class="badge bg-warning">Pending Review</span>
                                {% elif case.status == 'completed' %}
                                    {% if case.actual_release_date %}
                                        <span class="badge bg-success">Completed</span>
                                    {% else %}
                                        <span class="badge bg-info">Working</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-secondary">{{ case.get_status_display }}</span>
                                {% endif %}
                            {% elif user.role == 'technician' %}
                                {% if case.assigned_to and case.assigned_to.id == user.id %}
                                    <span class="badge bg-info">Working</span>
                                {% else %}
                                    {% if case.status == 'draft' %}
                                        <span class="badge bg-secondary">Draft</span>
                                    {% elif case.status == 'submitted' %}
                                        <span class="badge bg-primary">Submitted</span>
                                    {% elif case.status == 'accepted' %}
                                        <span class="badge bg-success">Accepted</span>
                                    {% elif case.status == 'pending_review' %}
                                        <span class="badge bg-warning">Pending Review</span>
                                    {% elif case.status == 'completed' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ case.get_status_display }}</span>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                {% if case.status == 'draft' %}
                                    <span class="badge bg-secondary">Draft</span>
                                {% elif case.status == 'submitted' %}
                                    <span class="badge bg-primary">Submitted</span>
                                {% elif case.status == 'accepted' %}
                                    <span class="badge bg-success">Accepted</span>
                                {% elif case.status == 'pending_review' %}
                                    <span class="badge bg-warning">Pending Review</span>
                                {% elif case.status == 'completed' %}
                                    <span class="badge bg-success">Completed</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ case.get_status_display }}</span>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Member Notes to Benefits Team -->
            {% if case.status == 'draft' and user.role == 'member' and case.member == user %}
                <div class="card mb-4 border-info">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Member Notes to Benefits Team</h6>
                        {% if not case.special_notes %}
                        <button type="button" class="btn btn-sm btn-info" id="addNotesBtn" onclick="toggleEditMode()">
                            <i class="bi bi-pencil"></i> Add Notes
                        </button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if case.special_notes %}
                            <div id="notesDisplay" class="p-3 bg-light rounded">
                                {{ case.special_notes|linebreaks }}
                            </div>
                            <div id="notesEdit" style="display: none;">
                                <textarea id="notesEditField" class="form-control" rows="4">{{ case.special_notes }}</textarea>
                            </div>
                        {% else %}
                            <div id="notesDisplay" class="p-3 bg-light rounded text-muted">
                                No notes added yet
                            </div>
                            <div id="notesEdit" style="display: none;">
                                <textarea id="notesEditField" class="form-control" rows="4" placeholder="Add notes for the benefits team..."></textarea>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% elif case.special_notes %}
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Member Notes to Benefits Team</h6>
                </div>
                <div class="card-body">
                    <div class="p-3 bg-light rounded">
                        {{ case.special_notes|linebreaks }}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Pending Release Notice (Members only) -->
            {% if user.role == 'member' and case.status == 'completed' and case.actual_release_date is None %}
                <div class="alert alert-info mb-4">
                    <i class="bi bi-clock-history"></i>
                    <strong>This case is complete and will be available for review on {{ case.scheduled_release_date|date:"F j, Y" }}</strong>
                    <p class="mt-2 mb-0">The report and supporting documents will be displayed once the release date arrives.</p>
                </div>
            {% endif %}

            <!-- Release Status (if applicable) -->
            {% if case.status == 'completed' and user.role != 'member' %}
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-check"></i> Release Status
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if case.actual_release_date %}
                            <div class="alert alert-success" role="alert">
                                <i class="bi bi-check-circle"></i>
                                <strong>This case was released on:</strong><br>
                                {{ case.actual_release_date|date:"F j, Y \a\t g:i A" }}
                            </div>
                        {% elif case.scheduled_release_date %}
                            <div class="alert alert-info" role="alert">
                                <i class="bi bi-calendar-event"></i>
                                <strong>This case is scheduled to be released on:</strong><br>
                                {{ case.scheduled_release_date|date:"F j, Y" }}
                                {% if can_release_immediately %}
                                    <br><br>
                                    <button type="button" class="btn btn-sm btn-success" onclick="releaseImmediately({{ case.id }})">
                                        <i class="bi bi-check-circle"></i> Release Immediately
                                    </button>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="alert alert-warning" role="alert">
                                <i class="bi bi-info-circle"></i>
                                <strong>This case is completed but no release date has been set.</strong>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <!-- Document Summary Alert -->
            <div class="alert alert-light border mb-4">
                <h6 class="mb-2"><i class="bi bi-file-earmark"></i> Document Summary:</h6>
                <div>
                    {% regroup documents by document_type as docs_by_type %}
                    {% for doc_type_group in docs_by_type %}
                        {% if doc_type_group.grouper == 'Federal Fact Finder' %}
                            Federal Fact Finder: {{ doc_type_group.list|length }} file(s)<br>
                        {% elif doc_type_group.grouper == 'Supporting Document' %}
                            Supporting Documents: {{ doc_type_group.list|length }} file(s)<br>
                        {% endif %}
                    {% empty %}
                        Federal Fact Finder: 0 file(s)<br>
                        Supporting Documents: 0 file(s)<br>
                    {% endfor %}
                    
                    <strong>Total: {{ documents|length }} document(s)</strong>
                </div>
            </div>

            <!-- Supporting Documents -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        Submitted Documents
                        <span class="badge bg-info">{{ documents|length }} Total</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if documents %}
                        {% regroup documents by document_type as docs_by_type %}
                        
                        <!-- Federal Fact Finder Documents -->
                        {% for doc_type_group in docs_by_type %}
                            {% if doc_type_group.grouper == 'fact_finder' %}
                            <div class="mb-4">
                                <h6 class="mb-3">
                                    <i class="bi bi-file-pdf" style="color: #dc3545;"></i> 
                                    Federal Fact Finder
                                    <span class="badge bg-primary">{{ doc_type_group.list|length }}</span>
                                </h6>
                                <div class="list-group">
                                    {% for doc in doc_type_group.list %}
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="bi bi-file-earmark-pdf"></i>
                                                {% if doc.file %}<a href="{{ doc.file.url }}" target="_blank" class="text-decoration-none">{% endif %}
                                                    <strong>{{ doc.original_filename }}</strong>
                                                {% if doc.file %}</a>{% endif %}
                                                <br><small class="text-muted">{{ doc.uploaded_at|date:"m/d/Y H:i" }}</small>
                                            </div>
                                            <div class="text-end">
                                                {% if doc.file %}<a href="{{ doc.file.url }}" class="btn btn-sm btn-outline-primary" download title="Download document">
                                                    <i class="bi bi-download"></i>
                                                </a>{% else %}<span class="badge bg-warning">No file</span>{% endif %}
                                                {% if can_edit and case.status != 'submitted' %}
                                                <form method="post" action="{% url 'cases:delete_document' doc.id %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this document?');" title="Delete document">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}

                        <!-- Supporting Documents -->
                        {% for doc_type_group in docs_by_type %}
                            {% if doc_type_group.grouper == 'supporting' %}
                            <div class="mb-4">
                                <h6 class="mb-3">
                                    <i class="bi bi-file-earmark" style="color: #6c757d;"></i> 
                                    Supporting Documents
                                    <span class="badge bg-secondary">{{ doc_type_group.list|length }}</span>
                                </h6>
                                <div class="list-group">
                                    {% for doc in doc_type_group.list %}
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="bi bi-file-earmark"></i>
                                                {% if doc.file %}<a href="{{ doc.file.url }}" target="_blank" class="text-decoration-none">{% endif %}
                                                    <strong>{{ doc.original_filename }}</strong>
                                                {% if doc.file %}</a>{% endif %}
                                                <br><small class="text-muted">{{ doc.uploaded_at|date:"m/d/Y H:i" }}</small>
                                            </div>
                                            <div class="text-end">
                                                {% if doc.file %}<a href="{{ doc.file.url }}" class="btn btn-sm btn-outline-primary" download title="Download document">
                                                    <i class="bi bi-download"></i>
                                                </a>{% else %}<span class="badge bg-warning">No file</span>{% endif %}
                                                {% if can_edit and case.status != 'submitted' %}
                                                <form method="post" action="{% url 'cases:delete_document' doc.id %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this document?');" title="Delete document">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                        
                        {% if case.status == 'draft' and user.role == 'member' and case.member == user %}
                        <div class="mt-4 pt-3 border-top">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadTechDocModal">
                                <i class="bi bi-upload"></i> Add More Documents
                            </button>
                        </div>
                        {% endif %}
                        
                    {% else %}
                    <p class="text-muted">No supporting documents uploaded yet. Download the Federal Fact Finder template below and upload it with your supporting documents.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Member Upload Section (for draft, pending_review, accepted, or completed cases) -->
            {% if case.status == 'draft' or case.status == 'pending_review' or case.status == 'accepted' or case.status == 'completed' %}
                {% if user.role == 'member' and case.member == user %}
            <div class="card mb-4 border-{% if case.status == 'completed' %}warning{% else %}info{% endif %}">
                <div class="card-header bg-light border-{% if case.status == 'completed' %}warning{% else %}info{% endif %}">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-upload"></i> 
                            {% if case.status == 'completed' %}Upload Additional Documents & Resubmit{% else %}Upload Documents{% endif %}
                        </h5>
                        {% if case.resubmission_count > 0 %}
                        <span class="badge bg-info">Resubmission #{{ case.resubmission_count }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info alert-permanent mb-4" role="alert">
                        <i class="bi bi-info-circle"></i>
                        <strong>This case has been completed.</strong> 
                        If you have additional documents or information that should be reviewed, 
                        you can upload them here and resubmit the case for further processing.
                    </div>

                    <!-- Document Upload Form -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Upload Supplementary Documents</h6>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{% url 'cases:upload_member_document_completed' case.id %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="document_file" class="form-label">Select File</label>
                                    <input type="file" class="form-control" id="document_file" name="document_file" required>
                                    <small class="text-muted">
                                        Accepted formats: PDF, Word, Excel, images, etc. (Max 50MB)
                                    </small>
                                </div>
                                <div class="mb-3">
                                    <label for="document_notes" class="form-label">Document Description (Optional)</label>
                                    <textarea class="form-control" id="document_notes" name="document_notes" rows="2" placeholder="Describe what this document contains..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-upload"></i> Upload Document
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Previously Uploaded Supplementary Documents -->
                    {% with supplementary_docs=documents %}
                        {% if supplementary_docs %}
                        <div class="mb-3">
                            <h6>Supplementary Documents Uploaded</h6>
                            <div class="list-group">
                                {% for doc in supplementary_docs %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                <i class="bi bi-file-earmark"></i> {{ doc.original_filename }}
                                            </h6>
                                            <small class="text-muted">
                                                Uploaded: {{ doc.uploaded_at|date:"M d, Y \a\t g:i A" }}
                                            </small>
                                            {% if doc.notes %}
                                            <br>
                                            <small class="text-secondary">
                                                {{ doc.notes }}
                                            </small>
                                            {% endif %}
                                        </div>
                                        {% if doc.file %}
                                        <a href="{{ doc.file.url }}" class="btn btn-sm btn-outline-primary ms-2" download title="Download this document">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% endwith %}

                    <!-- Resubmit Button -->
                    <div class="mt-4 pt-3 border-top">
                        <p class="text-muted small mb-3">
                            When ready, submit the form below to resubmit this case for technician review:
                        </p>
                        <a href="{% url 'cases:resubmit_case' case.id %}" class="btn btn-warning btn-lg">
                            <i class="bi bi-arrow-repeat"></i> Resubmit Case
                        </a>
                        <p class="text-muted small mt-3 mb-0">
                            <i class="bi bi-exclamation-triangle"></i>
                            Resubmitting will change the case status back to "Submitted" and notify the assigned technician to review your documents.
                        </p>
                    </div>
                </div>
            </div>
                {% endif %}
            {% endif %}

            <!-- Case Notes/Communication Section (Everyone can see and add) -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-left-text"></i> Notes & Communication
                        {% if case_notes.count > 0 %}
                        <span class="badge bg-warning">{{ case_notes.count }}</span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if case_notes %}
                    <div class="list-group mb-3">
                        {% for note in case_notes %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    {% if note.author %}
                                        <strong>{{ note.author.get_full_name|default:note.author.username }}</strong>
                                        {% if note.is_internal %}<span class="badge bg-danger ms-2">Internal</span>{% endif %}
                                    {% else %}
                                        <strong class="text-muted">[Deleted User]</strong>
                                    {% endif %}
                                    <small class="text-muted d-block">{{ note.created_at|date:"m/d/Y H:i" }}</small>
                                </div>
                                {% if note.author and user.id == note.author.id or user.role == 'administrator' %}
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteNote({{ note.id }}, {{ case.id }})" title="Delete this note">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                            <p class="mt-2 mb-0">{{ note.note|linebreaks }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-3">No notes yet. Start the conversation!</p>
                    {% endif %}

                    <!-- Note: Everyone can add notes -->
                    <form method="post" action="{% url 'cases:add_case_note' case.id %}" class="mt-3">
                        {% csrf_token %}
                        <div class="form-group">
                            <textarea class="form-control" name="notes" rows="3" placeholder="Add a note to communicate with the team..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus-circle"></i> Add Note
                        </button>
                    </form>
                </div>
            </div>

            <!-- Audit History Tab (Manager/Admin only) -->
            {% if user.role in 'manager,administrator' and audit_logs %}
                {% include 'cases/case_audit_history_tab.html' %}
            {% endif %}

            <!-- Reports (Tech/Admin/Manager only OR Member if released) -->
            {% if can_view_report %}
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        Reports
                        {% if case.reports.count > 0 %}
                        <span class="badge bg-info">{{ case.reports.count }}</span>
                        {% endif %}
                    </h5>
                    {% if can_upload_reports %}
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadReportModal">
                        <i class="bi bi-upload"></i> Upload Report
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if case.reports.all %}
                    <div class="list-group">
                        {% for report in case.reports.all %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    {% if report.report_file %}
                                    <i class="bi bi-file-earmark"></i>
                                    <a href="{{ report.report_file.url }}" target="_blank" class="text-decoration-none">
                                        <strong>Report #{{ report.report_number }}</strong>
                                    </a>
                                    {% else %}
                                    <i class="bi bi-file-earmark"></i>
                                    <strong>Report #{{ report.report_number }}</strong>
                                    {% endif %}
                                    <br><small class="text-muted">
                                        Status: <span class="badge bg-secondary">{{ report.get_status_display }}</span>
                                        {% if report.notes %}| Notes: {{ report.notes|truncatewords:10 }}{% endif %}
                                    </small>
                                </div>
                                <div class="text-end">
                                    {% if report.report_file %}
                                    <a href="{{ report.report_file.url }}" class="btn btn-sm btn-outline-primary" download>
                                        <i class="bi bi-download"></i>
                                    </a>
                                    {% endif %}
                                    <br><small class="text-muted">{{ report.updated_at|date:"m/d/Y H:i" }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">No reports uploaded yet.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Technician Notes PDF Download -->
            {% if can_view_report and case.report_notes_to_member %}
            <div class="card mb-4 border-info">
                <div class="card-header bg-info bg-opacity-10 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-sticky"></i> Technical Notes
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        <i class="bi bi-info-circle"></i> 
                        Formatted notes compiled by the technician reviewing your case.
                    </p>
                    <a href="{% url 'cases:generate_report_notes_pdf' case.id %}" class="btn btn-info" download>
                        <i class="bi bi-file-earmark-pdf"></i> Download Notes as PDF
                    </a>
                    <small class="text-muted d-block mt-2">
                        PDF generated with full formatting and all images
                    </small>
                </div>
            </div>
            {% endif %}

            <!-- Additional Documents (Tech/Admin/Manager only OR Member if released) -->
            {% if can_view_report %}
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Additional Documents</h5>
                    {% if can_edit %}
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadTechDocModal">
                        <i class="bi bi-upload"></i> Upload Document
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if tech_documents %}
                    <div class="list-group">
                        {% for doc in tech_documents %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <i class="bi bi-file-earmark"></i>
                                    <a href="{{ doc.file.url }}" target="_blank" class="text-decoration-none">
                                        <strong>{{ doc.original_filename }}</strong>
                                    </a>
                                    <br><small class="text-muted">
                                        {% if doc.notes %}{{ doc.notes|truncatewords:15 }}<br>{% endif %}
                                        Uploaded by {{ doc.uploaded_by.get_full_name|default:doc.uploaded_by.username }} on {{ doc.uploaded_at|date:"m/d/Y H:i" }}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <a href="{{ doc.file.url }}" class="btn btn-sm btn-outline-primary" download>
                                        <i class="bi bi-download"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">No technician documents uploaded yet. Click "Upload Document" to add supporting files.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

        </div>

        <!-- Right Column: Timeline & Actions (Technician/Admin only) -->
        <div class="col-md-4">
            {% if user.role != 'member' %}
                <!-- Assignment -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Assignment</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Assigned To:</strong><br>
                            {% if case.assigned_to %}
                                {{ case.assigned_to.username }}
                                <br><small class="text-muted">{{ case.assigned_to.user_level }}</small>
                            {% else %}
                                <span class="text-muted">Unassigned</span>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <strong>Reviewed By:</strong><br>
                            {% if case.reviewed_by %}
                                {{ case.reviewed_by.username }}
                                <br><small class="text-muted">{{ case.reviewed_by.user_level }}</small>
                            {% else %}
                                <span class="text-muted">Not reviewed</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Member Notification Status -->
                {% if case.status == 'completed' %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Member Notification</h5>
                    </div>
                    <div class="card-body">
                        {% if case.actual_email_sent_date %}
                            <div class="alert alert-success alert-permanent mb-0">
                                <i class="bi bi-envelope-check"></i> <strong>Member Notified</strong>
                                <br><small>Email sent on {{ case.actual_email_sent_date|date:"M d, Y \a\t g:i A" }} CST</small>
                                {% if case.member %}
                                    <br><small class="text-muted">To: {{ case.member.email }}</small>
                                {% endif %}
                            </div>
                        {% elif case.scheduled_email_date %}
                            <div class="alert alert-info alert-permanent mb-0">
                                <i class="bi bi-hourglass-split"></i> <strong>Notification Scheduled</strong>
                                <br><small>Will be sent on {{ case.scheduled_email_date|date:"M d, Y" }}</small>
                                {% if case.member %}
                                    <br><small class="text-muted">To: {{ case.member.email }}</small>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="alert alert-warning alert-permanent mb-0">
                                <i class="bi bi-exclamation-triangle"></i> <strong>No Notification Scheduled</strong>
                                <br><small>Member will not receive notification for this case.</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Timeline -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Timeline</h5>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            <div class="timeline-item">
                                <strong>Submitted:</strong><br>
                                {{ case.date_submitted|date:"m/d/Y H:i" }}
                            </div>
                            {% if case.date_accepted %}
                            <div class="timeline-item">
                                <strong>Accepted:</strong><br>
                                {{ case.accepted_at|date:"m/d/Y H:i" }}
                            </div>
                            {% endif %}
                            {% if case.date_completed %}
                            <div class="timeline-item">
                                <strong>Completed:</strong><br>
                                {{ case.date_completed|date:"m/d/Y H:i" }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            {% if case.status == 'pending_review' and user.role == 'technician' and user.user_level in 'level_2,level_3' %}
                                <!-- Quality Review Actions for Level 2/3 Technicians -->
                                <div class="alert alert-info mb-3">
                                    <strong><i class="bi bi-check-circle"></i> Quality Review Required</strong>
                                    <p class="mb-0 small">Review and approve this case from Level 1 technician {{ case.assigned_to.first_name }} {{ case.assigned_to.last_name }}</p>
                                </div>
                                
                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveReviewModal">
                                    <i class="bi bi-check-circle"></i> Approve Case
                                </button>
                                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#revisionsModal">
                                    <i class="bi bi-pencil"></i> Request Revisions
                                </button>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#correctionsModal">
                                    <i class="bi bi-wrench"></i> Apply Corrections
                                </button>
                            {% elif case.assigned_to == user %}
                                <!-- Standard Technician Actions -->
                                {% if case.status == 'completed' %}
                                    <button type="button" class="btn btn-secondary" id="markCompletedBtn" onclick="markCaseIncomplete()">
                                        <i class="bi bi-arrow-counterclockwise"></i> Mark as Incomplete
                                    </button>
                                    <p class="text-muted small mt-2 mb-0">
                                        <i class="bi bi-info-circle"></i> This case was completed on {{ case.date_completed|date:"m/d/Y H:i" }}
                                    </p>
                                {% else %}
                                    <button type="button" class="btn btn-success" id="markCompletedBtn" onclick="markCaseCompleted()">
                                        <i class="bi bi-check-circle"></i> Mark as Completed
                                    </button>
                                    <button class="btn btn-warning" disabled>
                                        <i class="bi bi-pause-circle"></i> Put on Hold
                                    </button>
                                    <button class="btn btn-primary" disabled>
                                        <i class="bi bi-arrow-right-circle"></i> Submit for Review
                                    </button>
                                    <hr>
                                    <small class="text-muted" id="actionHelp">
                                        <i class="bi bi-info-circle"></i> At least one report must be uploaded before marking as completed.
                                    </small>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle"></i> You have not taken ownership of this case. Case actions are only available to the assigned technician.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Upload Report Modal -->
<div class="modal fade" id="uploadReportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'cases:upload_case_report' case.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="reportNumber" class="form-label">Report Number <span class="text-danger">*</span></label>
                        <select class="form-select" id="reportNumber" name="report_number" required>
                            <option value="">-- Select Report Number --</option>
                            {% for i in case.get_report_numbers %}
                            <option value="{{ i }}">Report {{ i }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Requested: {{ case.num_reports_requested }} report{{ case.num_reports_requested|pluralize }}</small>
                    </div>
                    <div class="mb-3">
                        <label for="reportFile" class="form-label">Select File <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="reportFile" name="report_file" required>
                        <small class="text-muted">Accepts PDF, DOC, DOCX, XLS, XLSX, and other common formats</small>
                    </div>
                    <div class="mb-3">
                        <label for="reportNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="reportNotes" name="report_notes" rows="3" placeholder="Add any notes about this report..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload"></i> Upload Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Upload Document Modal -->
<div class="modal fade" id="uploadTechDocModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                {% if user.role == 'technician' %}
                    <h5 class="modal-title">Upload Technician Document</h5>
                {% else %}
                    <h5 class="modal-title">Upload Document</h5>
                {% endif %}
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'cases:upload_technician_document' case.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="techDocFile" class="form-label">Select File <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="techDocFile" name="document_file" required>
                        <small class="text-muted">Accepts PDF, DOC, DOCX, XLS, XLSX, images, and other common formats</small>
                    </div>
                    <div class="mb-3">
                        <label for="techDocNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="techDocNotes" name="document_notes" rows="3" placeholder="Add any notes about this document..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload"></i> Upload Document
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Note Modal -->
<div class="modal fade" id="addNoteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Internal Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'cases:add_case_note' case.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="noteText" class="form-label">Note <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="noteText" name="notes" rows="4" placeholder="Add an internal note..." required></textarea>
                        <small class="text-muted">This note will be visible to other technicians and administrators.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add Note
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function markCaseCompleted() {
    const btn = document.getElementById('markCompletedBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Validating...';
    
    // First, validate that case can be completed
    fetch('{% url "cases:validate_case_completion" case.id %}', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (!data.valid) {
            // Validation failed
            if (data.canOverride) {
                // Show warning with override option
                const alertHtml = `
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Warning:</strong> ${data.error}
                        <hr>
                        <p class="mb-2">${data.warning}</p>
                        <button type="button" class="btn btn-sm btn-warning me-2" onclick="confirmCaseCompletionOverride()">
                            <i class="bi bi-check-circle"></i> Yes, Complete Anyway
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="alert">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                    </div>
                `;
                document.querySelector('.card-body').insertAdjacentHTML('beforebegin', alertHtml);
            } else {
                // Show hard error (no override allowed)
                const alertHtml = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-circle"></i> ${data.error}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                document.querySelector('.card-body').insertAdjacentHTML('beforebegin', alertHtml);
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Mark as Completed';
            return;
        }
        
        // Validation passed - show release options modal
        const releaseModal = new bootstrap.Modal(document.getElementById('releaseOptionsModal'));
        releaseModal.show();
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Mark as Completed';
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while validating your request.');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Mark as Completed';
    });
}

function confirmCaseCompletionOverride() {
    // User confirmed they want to override the missing reports validation
    const releaseModal = new bootstrap.Modal(document.getElementById('releaseOptionsModal'));
    releaseModal.show();
    // Store override flag for later use
    window.caseCompletionOverride = true;
}

function confirmCaseCompletion() {
    const btn = document.getElementById('confirmReleaseBtn');
    const releaseNowRadio = document.getElementById('releaseNow');
    const releaseDateInput = document.getElementById('releaseDate');
    
    let releaseOption = 'now';
    let releaseDate = null;
    
    if (!releaseNowRadio.checked) {
        releaseOption = 'schedule';
        releaseDate = releaseDateInput.value;
        
        if (!releaseDate) {
            alert('Please select a release date.');
            return;
        }
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
    
    // Proceed with marking as completed
    fetch('{% url "cases:mark_case_completed" case.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            release_option: releaseOption,
            release_date: releaseDate,
            override_incomplete: window.caseCompletionOverride || false
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle"></i> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.querySelector('.card-body').insertAdjacentHTML('beforebegin', alertHtml);
            
            // Close modal and reload the page after 2 seconds
            bootstrap.Modal.getInstance(document.getElementById('releaseOptionsModal')).hide();
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            // Show error message
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-circle"></i> ${data.error}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.querySelector('.card-body').insertAdjacentHTML('beforebegin', alertHtml);
            
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Confirm Release';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your request.');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Confirm Release';
    });
}

// Set minimum date to today + 7 days when modal is shown
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('releaseOptionsModal');
    if (modal) {
        modal.addEventListener('show.bs.modal', function() {
            const today = new Date();
            const minDate = new Date(today);
            minDate.setDate(minDate.getDate() + 1);  // Minimum 1 day from now for testing
            const dateInput = document.getElementById('releaseDate');
            const minDateStr = minDate.toISOString().split('T')[0];
            dateInput.min = minDateStr;
            dateInput.value = minDateStr;
            
            // Set max date to the case due date if it exists
            const caseDueDate = '{{ case.date_due|date:"Y-m-d" }}';
            if (caseDueDate && caseDueDate !== 'None' && caseDueDate.length > 0) {
                dateInput.max = caseDueDate;
                console.log('Date Input Min:', minDateStr);
                console.log('Date Input Max:', caseDueDate);
                // If the default date (1 day from now) is after due date, use due date instead
                if (minDateStr > caseDueDate) {
                    dateInput.value = caseDueDate;
                    console.log('Default date after due date, setting to:', caseDueDate);
                }
            } else {
                console.log('No due date set, min only:', minDateStr);
            }
        });
    }
    
    // Toggle date input based on radio selection
    const releaseNow = document.getElementById('releaseNow');
    const scheduleRelease = document.getElementById('scheduleRelease');
    const releaseDateGroup = document.getElementById('releaseDateGroup');
    
    if (releaseNow) {
        releaseNow.addEventListener('change', function() {
            if (releaseDateGroup) releaseDateGroup.style.display = 'none';
        });
    }
    
    if (scheduleRelease) {
        scheduleRelease.addEventListener('change', function() {
            if (releaseDateGroup) releaseDateGroup.style.display = 'block';
        });
    }
});

function markCaseIncomplete() {
    // Show confirmation dialog
    if (confirm('Are you sure you want to reactivate this case? It will be changed back to "Pending Review" status.')) {
        const btn = document.getElementById('markCompletedBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
        
        fetch('{% url "cases:mark_case_incomplete" case.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alertHtml = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle"></i> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                document.querySelector('.card-body').insertAdjacentHTML('beforebegin', alertHtml);
                
                // Reload the page after 2 seconds
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                // Show error message
                const alertHtml = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-circle"></i> ${data.error}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                document.querySelector('.card-body').insertAdjacentHTML('beforebegin', alertHtml);
                
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> Mark as Incomplete';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing your request.');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> Mark as Incomplete';
        });
    }
}

function deleteNote(noteId, caseId) {
    if (!confirm('Are you sure you want to delete this note? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/cases/${caseId}/delete-note/${noteId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to reflect the deletion
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete note'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the note.');
    });
}
</script>

<!-- Release Options Modal -->
<div class="modal fade" id="releaseOptionsModal" tabindex="-1" aria-labelledby="releaseOptionsLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="releaseOptionsLabel">
                    <i class="bi bi-calendar-check"></i> When should this case be released to the member?
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">Choose when the member should be able to see the completed case:</p>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="releaseOption" id="releaseNow" value="now" checked>
                    <label class="form-check-label" for="releaseNow">
                        <strong>Release Now</strong>
                        <br>
                        <small class="text-muted">Member can view the completed case immediately</small>
                    </label>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="releaseOption" id="scheduleRelease" value="schedule">
                    <label class="form-check-label" for="scheduleRelease">
                        <strong>Schedule Release</strong>
                        <br>
                        <small class="text-muted">Member will see the case on a specific date</small>
                    </label>
                </div>
                
                <div id="releaseDateGroup" style="display: none; margin-top: 20px;">
                    <label for="releaseDate" class="form-label">Release Date:</label>
                    <input type="date" class="form-control" id="releaseDate">
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle"></i> Default is 7 days from completion. You can select a later date if preferred.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmReleaseBtn" onclick="confirmCaseCompletion()">
                    <i class="bi bi-check-circle"></i> Confirm Release
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Admin Take Ownership Modal -->
<div class="modal fade" id="adminTakeOwnershipModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-person-check"></i> Take Case Ownership
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>You are about to take ownership of case <strong>{{ case.external_case_id }}</strong>.</p>
                
                {% if case.assigned_to %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Current Owner:</strong> {{ case.assigned_to.first_name }} {{ case.assigned_to.last_name }}
                    <br>
                    <small>This technician will no longer be the assigned owner.</small>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>No current owner.</strong> You will become the assigned owner.
                </div>
                {% endif %}
                
                <p class="text-muted mb-0">
                    <strong>After taking ownership, you will be able to:</strong>
                </p>
                <ul class="text-muted small">
                    <li>Upload and manage reports</li>
                    <li>Add internal notes</li>
                    <li>Mark the case as completed</li>
                    <li>Perform all technician functions</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'cases:admin_take_ownership' case.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-person-check"></i> Take Ownership
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Draft Case Edit Mode Functions
let isEditMode = false;

function toggleEditMode() {
    isEditMode = !isEditMode;
    
    // Toggle visibility of display vs edit fields
    const reportDisplay = document.getElementById('reportDisplay');
    const reportEdit = document.getElementById('reportEdit');
    const dueDateDisplay = document.getElementById('dueDateDisplay');
    const dueDateEdit = document.getElementById('dueDateEdit');
    const notesDisplay = document.getElementById('notesDisplay');
    const notesEdit = document.getElementById('notesEdit');
    const editDraftBtn = document.getElementById('editDraftBtn');
    const editActions = document.getElementById('editActions');
    
    if (isEditMode) {
        // Show edit fields
        if (reportDisplay) reportDisplay.style.display = 'none';
        if (reportEdit) reportEdit.style.display = 'block';
        if (dueDateDisplay) dueDateDisplay.style.display = 'none';
        if (dueDateEdit) dueDateEdit.style.display = 'block';
        if (notesDisplay) notesDisplay.style.display = 'none';
        if (notesEdit) notesEdit.style.display = 'block';
        if (editDraftBtn) editDraftBtn.style.display = 'none';
        if (editActions) editActions.style.display = 'block';
    } else {
        // Hide edit fields
        if (reportDisplay) reportDisplay.style.display = 'inline';
        if (reportEdit) reportEdit.style.display = 'none';
        if (dueDateDisplay) dueDateDisplay.style.display = 'inline';
        if (dueDateEdit) dueDateEdit.style.display = 'none';
        if (notesDisplay) notesDisplay.style.display = 'block';
        if (notesEdit) notesEdit.style.display = 'none';
        if (editDraftBtn) editDraftBtn.style.display = 'inline-block';
        if (editActions) editActions.style.display = 'none';
    }
}

function cancelEditMode() {
    isEditMode = true;  // Set to true so toggleEditMode will set it to false
    toggleEditMode();
    
    // Force reset of field values to original
    const reportEdit = document.getElementById('reportEdit');
    const dueDateEdit = document.getElementById('dueDateEdit');
    const notesEditField = document.getElementById('notesEditField');
    
    // Reset to original values (they're already there from HTML)
    if (reportEdit && reportEdit.querySelectorAll) {
        // Just toggle back to display mode, original values stay in HTML
    }
}

function saveDraftChanges() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "cases:case_detail" case.id %}';
    
    // Add CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrftoken) {
        form.appendChild(csrftoken.cloneNode(true));
    }
    
    // Add hidden input for edit action
    const editInput = document.createElement('input');
    editInput.type = 'hidden';
    editInput.name = 'edit_draft';
    editInput.value = 'true';
    form.appendChild(editInput);
    
    // Get values from edit fields
    const reportEdit = document.getElementById('reportEdit');
    const dueDateEdit = document.getElementById('dueDateEdit');
    const notesEditField = document.getElementById('notesEditField');
    
    if (reportEdit) {
        const reportInput = document.createElement('input');
        reportInput.type = 'hidden';
        reportInput.name = 'num_reports_requested';
        reportInput.value = reportEdit.value;
        form.appendChild(reportInput);
    }
    
    if (dueDateEdit) {
        const dueDateInput = document.createElement('input');
        dueDateInput.type = 'hidden';
        dueDateInput.name = 'date_due';
        dueDateInput.value = dueDateEdit.value;
        form.appendChild(dueDateInput);
    }
    
    if (notesEditField) {
        const notesInput = document.createElement('input');
        notesInput.type = 'hidden';
        notesInput.name = 'special_notes';
        notesInput.value = notesEditField.value;
        form.appendChild(notesInput);
    }
    
    document.body.appendChild(form);
    form.submit();
}

// Credit adjustment modal handler
function submitCreditAdjustment() {
    const creditSelect = document.getElementById('creditAdjustSelect');
    const reasonInput = document.getElementById('creditReason');
    const creditValue = creditSelect.value;
    const reason = reasonInput.value || 'Manual adjustment';
    
    const formData = new FormData();
    formData.append('credit_value', creditValue);
    formData.append('reason', reason);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('{% url "cases:adjust_case_credit" case.id %}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('creditDisplay').textContent = data.new_credit;
            const modal = bootstrap.Modal.getInstance(document.getElementById('creditAdjustModal'));
            if (modal) modal.hide();
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = '<strong>Success!</strong> Credit value updated to ' + data.new_credit + '.<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
            
            // Insert alert at the top of the page
            const firstRow = document.querySelector('.container-fluid .row');
            if (firstRow && firstRow.parentNode) {
                firstRow.parentNode.insertBefore(alertDiv, firstRow);
            } else {
                // Fallback: append to container
                document.querySelector('.container-fluid').appendChild(alertDiv);
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown error occurred'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating credit: ' + error.message);
    });
}

// Take Ownership Function (for technicians)
function takeOwnership(caseId) {
    if (!confirm('Take ownership of this case?')) {
        return;
    }
    
    const formData = new FormData();
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
    
    fetch(`/cases/${caseId}/take-ownership/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || `HTTP ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to take ownership'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

// Helper function to get CSRF token from cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Release case immediately (for technician who owns it or admin)
function releaseImmediately(caseId) {
    if (confirm('Are you sure you want to release this case immediately to the member? This action cannot be undone.')) {
        fetch(`/cases/${caseId}/release-immediately/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message and reload
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while releasing the case.');
        });
    }
}
</script>

<!-- Credit Adjustment Modal -->
<div class="modal fade" id="creditAdjustModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adjust Case Credit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="creditAdjustSelect" class="form-label">Credit Value</label>
                    <select class="form-select" id="creditAdjustSelect">
                        <option value="0.5" {% if case.credit_value|add:0 == 0.5 %}selected{% endif %}>0.5</option>
                        <option value="1.0" {% if case.credit_value|add:0 == 1.0 %}selected{% endif %}>1.0</option>
                        <option value="1.5" {% if case.credit_value|add:0 == 1.5 %}selected{% endif %}>1.5</option>
                        <option value="2.0" {% if case.credit_value|add:0 == 2.0 %}selected{% endif %}>2.0</option>
                        <option value="2.5" {% if case.credit_value|add:0 == 2.5 %}selected{% endif %}>2.5</option>
                        <option value="3.0" {% if case.credit_value|add:0 == 3.0 %}selected{% endif %}>3.0</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="creditReason" class="form-label">Reason for Adjustment</label>
                    <textarea class="form-control" id="creditReason" rows="3" placeholder="Explain why this adjustment was made..."></textarea>
                </div>
                <div class="alert alert-info small">
                    <strong>Note:</strong> This adjustment will be logged in the audit trail and visible to managers for reconciliation.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitCreditAdjustment()">Save Credit Adjustment</button>
            </div>
        </div>
    </div>
</div>

<!-- Reassign Modal -->
<div class="modal fade" id="reassignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-arrow-repeat"></i> Reassign Case</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="reassignForm" method="post" action="{% url 'cases:reassign_case' case.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="reassignTech" class="form-label"><strong>Reassign to Technician</strong></label>
                        <select class="form-select" id="reassignTech" name="assigned_to" required>
                            <option value="">Select a technician...</option>
                            {% for tech in available_techs %}
                                <option value="{{ tech.id }}">{{ tech.get_full_name }} ({{ tech.get_user_level_display }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reassignReason" class="form-label">Reason (optional)</label>
                        <textarea class="form-control" id="reassignReason" name="reason" rows="3" placeholder="Why are you reassigning this case?"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning"><i class="bi bi-check"></i> Reassign</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Floating Report Notes Window with Rich Text Editor -->
{% if user.role in 'technician,administrator,manager' and case.status in 'accepted,pending_review,completed' %}
<div id="floatingNotesWindow" class="floating-window">
    <div class="floating-window-header">
        <span class="floating-window-title">
            <i class="bi bi-sticky"></i> Report Notes to Member
        </span>
        <div class="floating-window-controls">
            <button type="button" class="floating-window-btn" onclick="minimizeFloatingNotes()" title="Minimize">
                <i class="bi bi-dash"></i>
            </button>
            <button type="button" class="floating-window-close" onclick="closeFloatingNotes()">
                <i class="bi bi-x"></i>
            </button>
        </div>
    </div>
    <div class="floating-window-body">
        <textarea 
            id="reportNotesTextarea" 
            class="tinymce-editor"
        >{{ case.report_notes_to_member|safe }}</textarea>
        <small class="text-muted d-block mt-2">
            <i class="bi bi-info-circle"></i> 
            These formatted notes will be visible to the member once the case is released.
        </small>
    </div>
</div>

<!-- Button to Minimize Notes Window -->
<button id="minimizeNotesButton" class="btn btn-outline-primary" onclick="minimizeFloatingNotes()" 
    style="position: fixed; bottom: 20px; right: 20px; z-index: 9998; display: none;">
    <i class="bi bi-sticky"></i> Notes
</button>

<!-- TinyMCE Library - Development Mode (No API key required for local development) -->
<script src="https://cdn.jsdelivr.net/npm/tinymce@6/tinymce.min.js"></script>

<style>
.floating-window {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 500px;
    max-height: 600px;
    background: white;
    border: 2px solid #007bff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    cursor: move;
    user-select: none;
}

.floating-window.hidden {
    display: none !important;
}

.floating-window-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    padding: 12px 15px;
    border-radius: 6px 6px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    cursor: grab;
    user-select: none;
}

.floating-window-header:active {
    cursor: grabbing;
}

.floating-window-title {
    display: flex;
    align-items: center;
    gap: 8px;
}

.floating-window-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.floating-window-close:hover {
    background: rgba(255, 255, 255, 0.3);
}

.floating-window-controls {
    display: flex;
    gap: 6px;
    align-items: center;
}

.floating-window-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.floating-window-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.floating-window-body {
    padding: 12px 15px;
    overflow-y: auto;
    flex: 1;
    display: flex;
    flex-direction: column;
}

/* TinyMCE in floating window */
.tinymce-editor {
    width: 100% !important;
    min-height: 300px !important;
}

.floating-notes-saving {
    opacity: 0.7;
}

.floating-notes-saved {
    border-color: #28a745 !important;
}
</style>

<script>
// Initialize TinyMCE with rich text features for notes
tinymce.init({
    selector: '.tinymce-editor',
    plugins: 'link image paste code advlist lists',
    toolbar: 'formatselect | bold italic underline forecolor | link image | numlist bullist | code',
    menubar: false,
    statusbar: false,
    height: 300,
    resize: false,
    branding: false,
    promotion: false,
    convert_urls: false,
    relative_urls: false,
    images_upload_url: '/cases/upload-image/',
    automatic_uploads: true,
    file_picker_types: 'image',
    license_key: 'gpl',
    setup: function(editor) {
        let notesAutoSaveTimeout = null;
        let notesLastSaved = '';
        
        editor.on('init', function() {
            notesLastSaved = editor.getContent();
            setupFloatingWindowDrag();
            
            // Load saved position from localStorage
            const notesWindow = document.getElementById('floatingNotesWindow');
            const savedPos = localStorage.getItem('notesWindowPos');
            if (savedPos) {
                const pos = JSON.parse(savedPos);
                notesWindow.style.bottom = pos.bottom + 'px';
                notesWindow.style.right = pos.right + 'px';
                notesWindow.style.left = 'auto';
                notesWindow.style.top = 'auto';
            }
            
            // Restore minimized state (default: SHOWN)
            const wasMinimized = localStorage.getItem('notesWindowMinimized');
            if (wasMinimized === 'true') {
                minimizeFloatingNotes();
            } else {
                // Show window by default
                notesWindow.style.display = 'flex';
                document.getElementById('minimizeNotesButton').style.display = 'none';
            }
        });
        
        // Auto-save on content change
        editor.on('change keyup', function() {
            clearTimeout(notesAutoSaveTimeout);
            notesAutoSaveTimeout = setTimeout(function() {
                saveReportNotes(editor);
            }, 1000); // Save 1 second after user stops typing
        });
    }
});

// Floating Notes Window Management
let notesWindowDragging = false;
let notesWindowOffset = { x: 0, y: 0 };

function setupFloatingWindowDrag() {
    const header = document.querySelector('.floating-window-header');
    const notesWindow = document.getElementById('floatingNotesWindow');
    
    if (!header || !notesWindow) return;
    
    header.addEventListener('mousedown', function(e) {
        notesWindowDragging = true;
        notesWindowOffset.x = e.clientX - notesWindow.getBoundingClientRect().left;
        notesWindowOffset.y = e.clientY - notesWindow.getBoundingClientRect().top;
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!notesWindowDragging) return;
        
        const x = e.clientX - notesWindowOffset.x;
        const y = e.clientY - notesWindowOffset.y;
        
        notesWindow.style.left = x + 'px';
        notesWindow.style.top = y + 'px';
        notesWindow.style.right = 'auto';
        notesWindow.style.bottom = 'auto';
    });
    
    document.addEventListener('mouseup', function() {
        if (notesWindowDragging) {
            notesWindowDragging = false;
            
            // Save position
            const rect = notesWindow.getBoundingClientRect();
            const pos = {
                left: rect.left,
                top: rect.top,
                right: window.innerWidth - rect.right,
                bottom: window.innerHeight - rect.bottom
            };
            localStorage.setItem('notesWindowPos', JSON.stringify(pos));
        }
    });
}

function openFloatingNotes() {
    const notesWindow = document.getElementById('floatingNotesWindow');
    const minimizeButton = document.getElementById('minimizeNotesButton');
    if (notesWindow) {
        notesWindow.style.display = 'flex';
        minimizeButton.style.display = 'none';
        localStorage.setItem('notesWindowMinimized', 'false');
        
        // Focus editor
        const editor = tinymce.get('reportNotesTextarea');
        if (editor) editor.focus();
    }
}

function closeFloatingNotes() {
    // Minimize instead of close - make it minimal for user to restore
    minimizeFloatingNotes();
}

function minimizeFloatingNotes() {
    const notesWindow = document.getElementById('floatingNotesWindow');
    const minimizeButton = document.getElementById('minimizeNotesButton');
    if (notesWindow) {
        // Toggle visibility
        if (notesWindow.style.display === 'none') {
            // Restore window
            notesWindow.style.display = 'flex';
            minimizeButton.style.display = 'none';
            localStorage.setItem('notesWindowMinimized', 'false');
        } else {
            // Minimize window
            notesWindow.style.display = 'none';
            minimizeButton.style.display = 'block';
            localStorage.setItem('notesWindowMinimized', 'true');
        }
    }
}

function saveReportNotes(editor) {
    const notesContent = editor.getContent();
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name="csrfmiddlewaretoken"]')?.value || '');
    formData.append('report_notes_to_member', notesContent);
    
    // Show saving indicator
    const editorContainer = document.querySelector('.tox-tinymce');
    if (editorContainer) editorContainer.classList.add('floating-notes-saving');
    
    fetch(`/cases/{{ case.id }}/save-report-notes/`, {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (editorContainer) {
                editorContainer.classList.remove('floating-notes-saving');
                editorContainer.classList.add('floating-notes-saved');
                setTimeout(() => {
                    editorContainer.classList.remove('floating-notes-saved');
                }, 2000);
            }
        }
    })
    .catch(error => {
        console.error('Error saving notes:', error);
        if (editorContainer) editorContainer.classList.remove('floating-notes-saving');
    });
}
</script>

{% include 'cases/edit_case_details_modal.html' %}

<!-- Quality Review Modals -->
{% if case.status == 'pending_review' and user.role == 'technician' and user.user_level in 'level_2,level_3' %}

<!-- Approve Review Modal -->
<div class="modal fade" id="approveReviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Approve Case Review</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'cases:approve_case_review' case.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Approving this case will mark it as <strong>Completed</strong> and release it to the member.</p>
                    <div class="form-group">
                        <label for="approveNotes" class="form-label">Review Notes (Optional)</label>
                        <textarea class="form-control" id="approveNotes" name="review_notes" rows="3" placeholder="Add quality review notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success"><i class="bi bi-check-circle"></i> Approve & Complete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Request Revisions Modal -->
<div class="modal fade" id="revisionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Request Revisions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'cases:request_case_revisions' case.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <p>This will return the case to the technician for revisions. They'll be notified with your feedback.</p>
                    <div class="form-group">
                        <label for="revisionFeedback" class="form-label">Revision Feedback <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="revisionFeedback" name="revision_feedback" rows="4" placeholder="Describe what needs to be revised..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning"><i class="bi bi-pencil"></i> Request Revisions</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Apply Corrections Modal -->
<div class="modal fade" id="correctionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Apply Corrections</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'cases:correct_case_review' case.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Applying corrections will complete this case with the corrections documented in the audit trail.</p>
                    <div class="form-group">
                        <label for="correctionNotes" class="form-label">Corrections Applied <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="correctionNotes" name="correction_notes" rows="4" placeholder="Document what corrections were applied..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger"><i class="bi bi-wrench"></i> Apply Corrections & Complete</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endif %}

{% endif %}

{% endblock %}